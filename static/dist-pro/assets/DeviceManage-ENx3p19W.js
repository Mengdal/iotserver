import{u as Ge}from"./useTable-Cg8mTZpf.js";import{_ as We}from"./Table.vue_vue_type_script_lang-D3v-kC-o.js";import{_ as ue}from"./ContentWrap.vue_vue_type_script_setup_true_lang-CrtdylkU.js";import{g as Ye,c as Ke,e as P,_ as Je}from"./index-CAdyeJt3.js";/* empty css               */import{m as Xe,d as _,i as O,b as m,F as Qe,ao as Ze,ap as el,am as ll,p as al,k as tl,aq as ol,e as nl}from"./element-plus--V1NSjC4.js";import{_ as il}from"./Dialog.vue_vue_type_style_index_0_lang-aEWcq84Q.js";import{j as dl,g as X,f as ce,h as Q,k as sl,l as rl,m as ul,n as cl,o as pl,p as ml}from"./index-BTXJkdku.js";import{d as vl}from"./dateUtil-HUUeH7cc.js";import{x as fl,aH as gl,r as c,aA as bl,c as pe,X as me,P as n,O as x,j as _l,ag as v,y as f,z as V,H as i,u as t,a4 as I,G as y,L as g,M as b,A as B,l as ve,K as yl,aa as xl}from"./vue-chunks-C1K3ngR7.js";/* empty css                        *//* empty css                *//* empty css                  */import"./el-checkbox-group-Cm0j4lwI.js";/* empty css                *//* empty css                         *//* empty css                  *//* empty css                       *//* empty css                  */import"./index-DfycOL0q.js";const hl={class:"mb-10px"},wl={class:"demo-drawer__content"},kl={style:{flex:"auto"}};function Z(R){return typeof R=="function"||Object.prototype.toString.call(R)==="[object Object]"&&!xl(R)}const Tl=fl({__name:"DeviceManage",setup(R){const ee=Ye(),le=gl(),M=c(0),{addRoute:Vl,push:fe}=bl(),{t:l}=Ke(),ae=c(),A=c(!1),C=c(!1),E=c(null),S=c([]),L=c(!1),r=c({radio:"Single",dn:"",dns:[],gwsn:"",headers:[],position_id:"",group_id:"",description:""}),te=c([]),ge=c([{label:l("device.online"),value:1},{label:l("device.offline"),value:0}]),N=c("add"),z=c([]),q=c([]),$=c([]),h=c(!1),F=c(),oe=c(!1),{status:H,productId:Cl}=le.query,p=c({name:"",projectId:"1",productId:"",status:H||H===0?String(H):""}),be=pe(()=>`${window.innerHeight-303}px`),U=c([]),_e=e=>{w()},ye=(e,a,s)=>{r.value.dn},{tableRegister:xe,tableState:ne,tableMethods:he}=Ge({fetchDataApi:async()=>{const{currentPage:e,pageSize:a}=ne;let s={};ee.getProject.enable?s={page:t(e),size:t(a),name:t(p.value.name)?t(p.value.name):void 0,status:t(p.value.status),productId:t(p.value.productId),projectId:ee.getProjectId}:s={page:t(e),size:t(a),name:t(p.value.name)?t(p.value.name):void 0,status:t(p.value.status),productId:t(p.value.productId)};const u=await sl(s);return{list:u.data.list,total:u.data.totalRow}}}),{dataList:we,total:ke,currentPage:G,pageSize:W}=ne,{getList:w}=he,Te=me([{field:"selection",type:"selection"},{field:"description",label:l("device.deviceName"),formatter:e=>e.description?e.description:"-"},{field:"name",label:l("device.deviceId")},{field:"GWSN",label:l("device.belongingGateway")},{field:"productName",label:l("device.belongingProduct")},{field:"group_name",label:l("device.belongingTag")},{field:"position_name",label:l("device.belongingLocation")},{field:"status",label:l("device.deviceStatus"),formatter:e=>n(Xe,{type:e.status=="1"?"success":"danger"},{default:()=>[e.status=="1"?l("device.online"):l("device.offline")]})},{field:"lastOnline",label:l("device.lastOnlineTime"),formatter:e=>e.lastOnline==0||e.lastOnline==null?"-":vl(e.lastOnline*1e3).format("YYYY-MM-DD HH:mm:ss")},{field:"action",label:l("device.operation"),width:240,slots:{default:e=>{let a,s,d;return n(x,null,[n(_,{text:!0,type:"success",onClick:()=>Y(e.row,"view")},Z(a=l("device.details"))?a:{default:()=>[a]}),n(P,{permission:"ChangeBind"},{default:()=>[n(_,{text:!0,type:"primary",onClick:()=>Y(e.row,"changeBand")},Z(s=l("device.edit"))?s:{default:()=>[s]})]}),n(P,{permission:"Delete"},{default:()=>[n(_,{text:!0,type:"danger",onClick:()=>Y(e.row,"del")},Z(d=l("device.delete"))?d:{default:()=>[d]})]})])}}}]),Y=(e,a)=>{a==="del"?O.confirm(l("common.delMessage"),l("common.delWarning"),{confirmButtonText:l("common.delOk"),cancelButtonText:l("common.delCancel"),type:"warning"}).then(()=>{dl({deviceName:e.name}).then(()=>{m.success(l("common.delSuccess")),w()}).catch(d=>{m.error(`${l("device.operationFailed")}: ${d.message||l("device.unknownError")}`)})}):a==="changeBand"?(r.value.radio="Single",Ve().then(()=>{N.value=a,r.value.dn=e.name,r.value.gwsn=Number(e.product_id),r.value.position_id=e.position_id?e.position_id:"",r.value.group_id=e.group_id?e.group_id:"",r.value.description=e.description?e.description:"",M.value=Date.now(),h.value=!0})):a==="view"&&fe(`/device/deviceManage/detail/${JSON.stringify({product_id:e.product_id,name:e.name})}`)},Ve=async()=>{try{const[e,a,s]=await Promise.all([X({page:1,size:1e4}),ce(),Q()]);return s.code===200&&(U.value=s.data.list.map(d=>({value:d.id,label:d.name}))),e.code===200&&a.code===200?(q.value=e.data.list.map(d=>({value:d.id,label:d.name})),$.value=ie(a.data),$.value,!0):(e.code!==200&&(console.error("获取产品列表失败:",e),m.error(l("device.failedToGetProductData"))),a.code!==200&&(console.error("获取位置树失败:",a),m.error(l("device.failedToGetLocationData"))),!1)}catch(e){return console.error("请求失败:",e),m.error(l("device.failedToGetData")),!1}},k=c([]),Ce=e=>{k.value=e},Se=()=>{O.confirm(l("device.confirmUnbindThisTag"),l("common.delWarning"),{confirmButtonText:l("common.ok"),cancelButtonText:l("common.cancel"),type:"warning"}).then(()=>{let e=k.value.map(d=>d.group_id).join(",");if(k.value,k.value.length===0||e.trim()===""){m.error(l("common.selectText"));return}let s={deviceIds:k.value.map(d=>d.id).join(",")};rl(s).then(d=>{d.code==200&&(m.success(l("device.operationSuccess")),w())})}).catch(()=>{})},ie=e=>Array.isArray(e)?e:e&&typeof e=="object"?[e]:[],De=async()=>{try{N.value="add",r.value={radio:"Single",dn:"",gwsn:""},A.value=!0;const[e,a,s,d]=await Promise.all([ul(),X({page:1,size:99999999}),ce(),Q()]);e.code===200&&(z.value=e.data.map(u=>({key:u.dn,label:u.dn,value:u.dn})),z.value),a.code===200&&(q.value=a.data.list.map(u=>({value:u.id,label:u.name}))),s.code==200&&($.value=ie(s.data),$.value),d.code===200&&(U.value=d.data.list.map(u=>({value:u.id,label:u.name}))),M.value=Date.now(),h.value=!0}catch(e){console.error("请求失败:",e),m.error(l("device.noDataAvailable"))}finally{A.value=!1}},Ie=me({dn:[{required:!0,message:l("device.pleaseSelectDeviceName"),trigger:"blur",validator:(e,a,s)=>{C.value&&(!a||a.length===0)?s(new Error(l("device.pleaseSelectAtLeastOneDevice"))):!C.value&&!a?s(new Error(l("device.pleaseSelectDevice"))):s()}}],gwsn:[{required:!0,message:l("common.selectText"),trigger:"blur"}],position_id:[{required:!0,message:l("common.selectText"),trigger:"blur"}],group_id:[{required:!0,message:l("common.selectText"),trigger:"blur"}],description:[{required:!0,message:"请输入",trigger:"blur"}]}),Be=e=>{switch(e){case"Single":C.value=!1;break;case"batch":C.value=!0;break}};pe(()=>C.value?"dns":"dn");const Le=()=>{ae.value.validate(e=>{if(!e){m.error(l("device.pleaseFillInCompleteInformation"));return}const{radio:a,dn:s,dns:d,gwsn:u,position_id:D}=r.value;if(a==="Single"&&!s||a==="batch"&&(!d||d.length===0)){m.error(l("device.pleaseSelectAtLeastOneDevice"));return}if(!u){m.error(l("device.pleaseSelectBelongingProduct"));return}const T={};r.value.position_id&&(T.positionId=String(r.value.position_id)),r.value.group_id&&(T.groupId=String(r.value.group_id)),r.value.description&&(T.description=r.value.description),t(d);const K={deviceName:a==="Single"?[s]:d,productId:Number(u),tags:T};cl(K).then(()=>{h.value=!1,m.success(l("base.success")),w()}).catch(J=>{m.error(`${l("device.operationFailed")}: ${J.message||l("device.unknownError")}`)})})},$e=e=>{O.confirm("确定绑定此标签",l("common.delWarning"),{confirmButtonText:l("common.ok"),cancelButtonText:l("common.cancel"),type:"warning"}).then(()=>{if(k.value.length===0){m.error(l("common.selectText"));return}let s={deviceIds:k.value.map(d=>d.id).join(", "),groupId:e.id};pl(s).then(d=>{d.code==200&&(m.success("操作成功"),w())})}).catch(()=>{})},Ue=async()=>{let e=await Q({page:1,size:999999});e.code==200&&(U.value=e.data.list),F.value&&F.value.handleOpen()},Pe=async()=>{let e=await X({page:1,size:999999});e.code===200&&(te.value=e.data?.list?.map(a=>({label:a.name,value:a.id})))};_l(()=>{const{productId:e,status:a}=le.query;e&&(p.value.productId=Number(e)),(a||a==0)&&(p.value.status=Number(a)),p.value.status,Pe()});const de=e=>{(e==="product"||e==="status")&&w()},Re=()=>{L.value=!0},Ne=(e,a)=>{const s=/\.(xls|xlsx|xlsm|xlsb)$/.test(e.name.toLowerCase()),d=e.size/1024/1024<5;if(!s)return m.error(`${l("base.only_excel")} (.xls, .xlsx, .xlsm, .xlsb)`),!1;if(!d)return m.error(l("base.file_size")),!1;S.value=a},ze=()=>{if(S.value.length===0){m.warning(l("base.please_select_file_first"));return}O.confirm(l("base.confirm_multiple"),l("common.delWarning"),{confirmButtonText:l("common.ok"),cancelButtonText:l("common.cancel"),type:"warning"}).then(()=>{try{new FormData().append("file",S.value[0].raw),S.value[0].raw,E.value=nl.service({lock:!0,text:l("base.data_importing"),background:"rgba(0, 0, 0, 0.7)"});let a={file:S.value[0].raw};ml(a).then(s=>{s.code==200&&(m.success(l("base.data_supplement_success")),L.value=!1,S.value=[],E.value.close())})}catch(e){}finally{E.value.close()}})},je=async()=>{try{const e="/static/数据补录模板.xlsx",a=`${l("device.Template")}.xlsx`,s=document.createElement("a");s.href=e,s.download=a,s.style.display="none",document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s),URL.revokeObjectURL(e)},100)}catch(e){console.error("下载失败:",e),alert(l("base.file_download_failed"))}};return(e,a)=>{const s=v("el-input"),d=v("el-form-item"),u=v("el-option"),D=v("el-select"),T=v("el-icon"),K=v("el-dropdown-item"),J=v("el-dropdown-menu"),Oe=v("el-dropdown"),se=v("el-form"),j=v("BaseButton"),re=v("el-radio-button"),Me=v("el-radio-group"),Ae=v("el-transfer"),Ee=v("el-tree-select"),qe=v("el-drawer"),Fe=v("el-upload");return f(),V(x,null,[n(t(ue),null,{default:i(()=>[n(se,{model:p.value,"label-position":"left",inline:!0},{default:i(()=>[n(d,{label:t(l)("device.deviceName")},{default:i(()=>[n(s,{modelValue:p.value.name,"onUpdate:modelValue":a[0]||(a[0]=o=>p.value.name=o),placeholder:t(l)("common.inputText")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),n(d,{label:t(l)("device.belongingProduct")},{default:i(()=>[n(D,{modelValue:p.value.productId,"onUpdate:modelValue":a[1]||(a[1]=o=>p.value.productId=o),clearable:"",style:{"min-width":"150px"},onChange:a[2]||(a[2]=o=>de("product"))},{default:i(()=>[(f(!0),V(x,null,I(te.value,o=>(f(),y(u,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),n(d,{label:t(l)("device.deviceStatus")},{default:i(()=>[n(D,{modelValue:p.value.status,"onUpdate:modelValue":a[3]||(a[3]=o=>p.value.status=o),clearable:"",style:{"min-width":"150px"},onChange:a[4]||(a[4]=o=>de("status"))},{default:i(()=>[(f(!0),V(x,null,I(ge.value,o=>(f(),y(u,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),n(d,null,{default:i(()=>[n(t(_),{type:"primary",onClick:a[5]||(a[5]=o=>_e(p.value)),icon:t(Qe),loading:oe.value},{default:i(()=>[g(b(t(l)("device.query")),1)]),_:1},8,["icon","loading"])]),_:1}),n(d,null,{default:i(()=>[n(t(P),{permission:"BindTag"},{default:i(()=>[n(Oe,{trigger:"contextmenu",ref_key:"dropdown1",ref:F},{dropdown:i(()=>[n(J,null,{default:i(()=>[(f(!0),V(x,null,I(U.value,(o,He)=>(f(),y(K,{key:He,onClick:Sl=>$e(o)},{default:i(()=>[g(b(o.name),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),default:i(()=>[n(t(_),{type:"primary",onClick:Ue},{default:i(()=>[g(b(t(l)("device.bindTag"))+" ",1),n(T,null,{default:i(()=>[n(t(Ze))]),_:1})]),_:1})]),_:1},512)]),_:1})]),_:1}),n(d,null,{default:i(()=>[n(t(P),{permission:"BatchUnbind"},{default:i(()=>[n(t(_),{type:"danger",onClick:a[6]||(a[6]=o=>Se()),icon:t(el)},{default:i(()=>[g(b(t(l)("device.unbindTag")),1)]),_:1},8,["icon"])]),_:1})]),_:1}),n(d,null,{default:i(()=>[n(t(_),{type:"primary",onClick:a[7]||(a[7]=o=>Re()),plain:"",icon:t(ll)},{default:i(()=>[g(b(e.$t("base.data_supplement")),1)]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),n(t(ue),null,{default:i(()=>[B("div",hl,[n(t(P),{permission:"BindPro"},{default:i(()=>[n(j,{type:"primary",onClick:De,loading:A.value,icon:t(al)},{default:i(()=>[g(b(t(l)("device.bindProduct")),1)]),_:1},8,["loading","icon"])]),_:1})]),n(t(We),{ref:"multipleTableRef",onSelectionChange:Ce,"row-key":"name",border:!1,pageSize:t(W),"onUpdate:pageSize":a[8]||(a[8]=o=>ve(W)?W.value=o:null),size:"small",currentPage:t(G),"onUpdate:currentPage":a[9]||(a[9]=o=>ve(G)?G.value=o:null),columns:Te,data:t(we),loading:oe.value,height:be.value,pagination:{total:t(ke),pageSizes:[20,40,50,100,1e3]},onRegister:t(xe),"node-key":"dn",showAction:"",stripe:""},null,8,["pageSize","currentPage","columns","data","loading","height","pagination","onRegister"]),h.value?(f(),y(qe,{key:M.value,modelValue:h.value,"onUpdate:modelValue":a[18]||(a[18]=o=>h.value=o),title:t(l)("device.bindProduct"),size:"70%",direction:"rtl",class:"demo-drawer"},{footer:i(()=>[B("div",kl,[n(t(_),{type:"primary",onClick:Le},{default:i(()=>[g(b(t(l)("common.ok")),1)]),_:1}),n(t(_),{onClick:a[17]||(a[17]=o=>h.value=!1)},{default:i(()=>[g(b(t(l)("common.cancel")),1)]),_:1})])]),default:i(()=>[B("div",wl,[n(se,{model:r.value,"label-position":"top",rules:Ie,ref_key:"ruleFormRef",ref:ae},{default:i(()=>[n(d,{label:t(l)("device.addDeviceMethod"),prop:"type"},{default:i(()=>[n(Me,{modelValue:r.value.radio,"onUpdate:modelValue":a[10]||(a[10]=o=>r.value.radio=o),onChange:Be},{default:i(()=>[n(re,{label:t(l)("device.singleDevice"),value:"Single"},null,8,["label"]),n(re,{label:t(l)("device.batchAdd"),value:"batch",disabled:N.value==="changeBand"},null,8,["label","disabled"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),r.value.radio==="Single"?(f(),y(d,{key:0,label:t(l)("device.device")+"ID","label-width":"80px",prop:"dn"},{default:i(()=>[n(D,{modelValue:r.value.dn,"onUpdate:modelValue":a[11]||(a[11]=o=>r.value.dn=o),placeholder:t(l)("common.selectText"),multiple:C.value,disabled:N.value==="changeBand",filterable:""},{default:i(()=>[(f(!0),V(x,null,I(z.value,o=>(f(),y(u,{key:o.key,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","multiple","disabled"])]),_:1},8,["label"])):(f(),y(d,{key:1,label:t(l)("device.device")+"ID","label-width":"80px",prop:"dns"},{default:i(()=>[n(Ae,{modelValue:r.value.dns,"onUpdate:modelValue":a[12]||(a[12]=o=>r.value.dns=o),style:{"text-align":"left",display:"inline-block"},filterable:"",titles:[t(l)("formDemo.unallocatedDevice"),t(l)("formDemo.productEquipment")],"button-texts":[t(l)("formDemo.Unassign"),t(l)("formDemo.Assignedtoproduct")],format:{noChecked:"${total}",hasChecked:"${checked}/${total}"},data:z.value,onChange:ye},null,8,["modelValue","titles","button-texts","data"])]),_:1},8,["label"])),n(d,{label:t(l)("device.deviceName")},{default:i(()=>[n(s,{modelValue:r.value.description,"onUpdate:modelValue":a[13]||(a[13]=o=>r.value.description=o),placeholder:t(l)("common.inputText")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),n(d,{label:t(l)("device.belongingProduct"),"label-width":"80px",prop:"gwsn"},{default:i(()=>[n(D,{modelValue:r.value.gwsn,"onUpdate:modelValue":a[14]||(a[14]=o=>r.value.gwsn=o),placeholder:t(l)("common.selectText")},{default:i(()=>[(f(!0),V(x,null,I(q.value,o=>(f(),y(u,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),n(d,{label:t(l)("device.belongingLocation"),"label-width":"80px"},{default:i(()=>[n(Ee,{clearable:"",modelValue:r.value.position_id,"onUpdate:modelValue":a[15]||(a[15]=o=>r.value.position_id=o),data:$.value,placeholder:t(l)("common.selectText"),"node-key":"id","check-strictly":"","render-after-expand":!1,props:{label:"name",value:"id",children:"children"}},null,8,["modelValue","data","placeholder"])]),_:1},8,["label"]),n(d,{label:t(l)("device.belongingTag"),"label-width":"80px"},{default:i(()=>[n(D,{modelValue:r.value.group_id,"onUpdate:modelValue":a[16]||(a[16]=o=>r.value.group_id=o),placeholder:t(l)("common.selectText"),clearable:""},{default:i(()=>[(f(!0),V(x,null,I(U.value,o=>(f(),y(u,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"])]),_:1},8,["model","rules"])])]),_:1},8,["modelValue","title"])):yl("",!0),n(t(il),{modelValue:L.value,"onUpdate:modelValue":a[20]||(a[20]=o=>L.value=o),title:t(l)("base.data_supplement"),maxHeight:240,initWidth:600},{footer:i(()=>[n(j,{type:"primary",onClick:ze},{default:i(()=>[g(b(t(l)("device.Import")),1)]),_:1}),n(j,{onClick:a[19]||(a[19]=o=>L.value=!1)},{default:i(()=>[g(b(e.$t("dialogDemo.close")),1)]),_:1}),n(j,{onClick:je,icon:t(tl),plain:""},{default:i(()=>[g(b(t(l)("device.Downloadtemplatefile")),1)]),_:1},8,["icon"])]),default:i(()=>[n(Fe,{ref:"uploadRef",drag:"",limit:1,"auto-upload":!1,accept:".xls,.xlsx,.xlsm,.xlsb","on-change":Ne},{tip:i(()=>a[21]||(a[21]=[B("div",{class:"el-upload__tip"},".xls、.xlsx、.xlsm、.xlsb a size less than 5mb",-1)])),default:i(()=>[n(T,{class:"el-icon--upload"},{default:i(()=>[n(t(ol))]),_:1}),a[22]||(a[22]=B("div",{class:"el-upload__text"},[g("Drop file here or "),B("em",null,"click to upload")],-1))]),_:1},512)]),_:1},8,["modelValue","title"])]),_:1})],64)}}}),Yl=Je(Tl,[["__scopeId","data-v-3092ceae"]]);export{Yl as default};
