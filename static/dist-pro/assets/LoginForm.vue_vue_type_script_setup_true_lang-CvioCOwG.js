import{F as N}from"./Form-CzZbC4Aj.js";import{u as q,g as B,d as C,i as H,c as O,n as z}from"./index-CAdyeJt3.js";/* empty css                */import{u as T}from"./useForm-CD85wrwf.js";import{l as $}from"./index-CL7E5KqJ.js";import{x as G,X as K,P as n,O as R,r as g,j as X,w as J,u as m,y as Q,G as W,aa as Y,aA as Z}from"./vue-chunks-C1K3ngR7.js";import{u as ee}from"./useValidator-Barz9SCp.js";import"./index-DfycOL0q.js";import{y as te}from"./element-plus--V1NSjC4.js";function oe(c){return typeof c=="function"||Object.prototype.toString.call(c)==="[object Object]"&&!Y(c)}const ge=G({__name:"LoginForm",emits:["to-register"],setup(c,{emit:se}){const ae="",h="production",{required:w}=ee(),p=q(),s=B(),u=C(),{currentRoute:I,addRoute:S,push:_}=Z(),{t:l}=O(),k={username:[w()],password:[w()]},j=K([{field:"title",colProps:{span:24},formItemProps:{slots:{default:()=>n("h2",{class:"text-2xl font-bold text-center w-[100%]"},[l("device.welcomeBack")])}}},{field:"username",label:l("login.username"),component:"Input",colProps:{span:24},componentProps:{placeholder:"Please enter your username"}},{field:"password",label:l("login.password"),component:"InputPassword",colProps:{span:24},componentProps:{style:{width:"100%"},placeholder:"Please enter your password",onKeydown:e=>{e.key==="Enter"&&(e.stopPropagation(),y())}}},{field:"tool",colProps:{span:24},formItemProps:{slots:{default:()=>n(R,null,[n("div",{class:"flex justify-between items-center w-[100%]"},[n(te,{modelValue:d.value,"onUpdate:modelValue":e=>d.value=e,label:l("login.remember"),size:"small"},null)])])}}},{field:"login",colProps:{span:24},formItemProps:{slots:{default:()=>{let e;return n(R,null,[n("div",{class:"w-[100%]"},[n(H,{loading:f.value,type:"primary",class:"w-[100%]",onClick:y},oe(e=l("login.login"))?e:{default:()=>[e]})])])}}}}]),d=g(s.getRememberMe),x=()=>{const e=s.getLoginInfo;if(e){const{username:t,password:r}=e;V({username:t,password:r})}};X(()=>{x()});const{formRegister:L,formMethods:F}=T(),{getFormData:M,getElFormExpose:U,setValues:V}=F,{setStorage:v,getStorage:re}=z("localStorage"),f=g(!1),A=g("");J(()=>I.value,e=>{A.value=e?.query?.redirect},{immediate:!0});const y=async()=>{await(await U())?.validate(async t=>{if(t){f.value=!0;const r=await M();try{const o=await $(r);if(o.code==200){m(d)?s.setLoginInfo({username:r.username,password:r.password}):s.setLoginInfo(void 0),s.setRememberMe(m(d)),s.setUserInfo(o.data),s.setToken(o.data.token),o.data,v("roleName",o.data.roleName);let i={enable:o.data.enable,projectList:o.data.project};s.setProject(i),s.getProject;let a="";h=="dev"||h=="production"&&(a=`http://${document.location.hostname}:8092/scada`),v("isUseScada",o.data.menu[0].children[0].meta.isUseScada);let E=[...o.data.menu,{id:0x650e124ef1c7,name:"scada",path:"",component:"#",parentId:null,status:1,type:0,meta:{title:"可视化",icon:"svg-icon:scada"},permissionList:{},children:[{id:0xca1c249de38e,name:"scadaManage",path:a,component:"#",parentId:0x650e124ef1c7,status:1,type:1,meta:{affix:!0,title:l("device.scada"),icon:"svg-icon:scada"},permissionList:{}}]}];const P=b(E);p.setFixedMenu(!1),p.setDynamicRouter(!0),p.setServerDynamicRouter(!0),await u.generateRoutes("server",P).catch(()=>{}),s.setRoleRouters(P),u.getAddRouters.forEach(D=>{S(D)}),_({path:u.addRouters[0].path})}}finally{f.value=!1}}})},b=e=>e.map(t=>{const r=a=>a==="null"?"":a,o=a=>a&&a===t.path?void 0:a,i={path:r(t.path),name:t.name,meta:t.meta};return t.component&&(i.component=t.component),t.redirect&&(i.redirect=o(t.redirect)),t.children?.length&&(i.children=b(t.children)),i});return(e,t)=>(Q(),W(m(N),{schema:j,rules:k,"label-position":"top","hide-required-asterisk":"",size:"large",class:"dark:border-1 dark:border-[var(--el-border-color)] dark:border-solid",onRegister:m(L)},null,8,["schema","onRegister"]))}});export{ge as _};
