import{x as se,r as _,c as ne,j as re,ag as f,aq as ie,y as b,z as M,P as r,H as u,L as V,M as I,u as v,I as N,Q as L,O as j,a4 as Q,G,A as k}from"./vue-chunks-C1K3ngR7.js";import{m as ce}from"./vue3-apexcharts-Bmjr8cT9.js";import{g as de,c as ue,f as w}from"./index-CAdyeJt3.js";import{_ as me}from"./ContentWrap.vue_vue_type_script_setup_true_lang-CrtdylkU.js";import{F as pe,G as ve}from"./element-plus--V1NSjC4.js";import{g as fe,a as ge,c as he,d as ye,e as _e}from"./index-BTXJkdku.js";import{_ as be}from"./Table.vue_vue_type_script_lang-D3v-kC-o.js";/* empty css                *//* empty css                  */import"./index-DfycOL0q.js";/* empty css                        *//* empty css                *//* empty css               */import"./el-checkbox-group-Cm0j4lwI.js";/* empty css                         *//* empty css                  *//* empty css                       */const ke={class:"flex flex-1 min-h-0"},we={class:"shrink-0"},xe={class:"flex justify-center items-center"},$e={class:"flex-1 min-h-0 overflow-hidden"},Te={class:"flex items-center"},Se={class:"ml-2 white space-nowrap truncate max-w-180px"},Ie={class:"table-container"},Qe=se({__name:"DaHistory",setup(Ne){const z=de(),{t:p}=ue(),Y=_([{label:"首值(first)",value:"first"},{label:"尾值(last)",value:"last"},{label:"最小值(min)",value:"min"},{label:"最大值(max)",value:"max"},{label:"总和(sum)",value:"sum"},{label:"平均值(mean)",value:"mean"},{label:"中位数(median)",value:"median"}]),C=_([]),D=_([]),J=_({label:"name",children:"children",isLeaf:e=>e.isTag}),U=ne(()=>`${window.innerHeight-152}px`),x=_(!1),B=_([]),P=_([]),o=_({startTime:w(new Date(new Date().setHours(0,0,0,0)),"yyyy-MM-dd HH:mm:ss"),endTime:w(new Date(new Date),"yyyy-MM-dd HH:mm:ss"),ids:"0",deviceName:"",checkList:[],aggType:"last",period:1800,isHistory:"2",count:100}),K=_([{label:`1${p("device.minute")}`,value:60},{label:`5${p("device.minute")}`,value:300},{label:`10${p("device.minute")}`,value:600},{label:`30${p("device.minute")}`,value:1800},{label:`1${p("device.hour")}`,value:25200}]),W={chart:{type:"area",stroke:{curve:"smooth"},zoom:{enabled:!0},toolbar:{show:!0,tools:{download:!0,zoom:!0,zoomin:!1,zoomout:!1,pan:!1,reset:!1}}},legend:{show:!0,position:"top",horizontalAlign:"center"},dataLabels:{enabled:!1},markers:{size:0},title:{align:"left"},fill:{type:"gradient",gradient:{shadeIntensity:1,inverseColors:!1,opacityFrom:.5,opacityTo:0,stops:[0,90,100]}},yaxis:{labels:{formatter:function(e){return e}}},xaxis:{labels:{formatter:function(e){return e},rotate:-70},tickAmount:50,tickPlacement:"on"}},X=async(e,t)=>{if(e.level===0){t(C.value);return}let m={};z.getProject.enable?m={productId:e.data.id,projectId:z.getProjectId}:m={productId:e.data.id};try{if(e.level===1){const n=await ge(m);if(n.code===200){const a=n.data.map(l=>({...l,id:`${e.data.id}-${l.name}`,isShowCheckbox:!1,children:l.children||[]}));t(a)}else t([])}else if(e.level===2){const n=e.data.children.map(a=>({...a,id:`${e.data.id}-${a.name}`,isShowCheckbox:!0,children:void 0}));t(n)}else t([])}catch(n){console.error("获取节点数据失败:",n),t([])}},Z=()=>{x.value=!0,o.value.isHistory==="1"?O():A()};re(()=>{ee()});const ee=async()=>{try{const e=await fe({page:1,size:1e4});e.code===200&&(C.value=e.data.list.map(t=>({id:t.id,name:t.name,children:[],isShowCheckbox:!1})))}catch(e){console.error("获取树形数据失败:",e)}},te=(e,t)=>!!e.isShowCheckbox,ae=e=>{if(e.checked){const t={type:e.type||"",nodeId:e.tag||e.name||"",name:e.name||""};o.value.checkList.some(s=>s.nodeId===t.nodeId&&s.type===t.type&&s.name===t.name)||(o.value.checkList=[...o.value.checkList,t])}else o.value.checkList=o.value.checkList.filter(t=>!(t.nodeId===(e.tag||e.name)&&t.type===e.type));x.value=!0,o.value.isHistory==="1"?O():A()},O=async()=>{o.value.checkList;try{const e=o.value.checkList.filter(a=>a.type).map(a=>a.nodeId).filter(Boolean),t=o.value.checkList.filter(a=>a.type&&(a.type.toUpperCase()==="bool"||a.type.toUpperCase()==="boolen")).map(a=>a.nodeId).filter(Boolean),m={startTime:w(o.value.startTime,"yyyy-MM-dd HH:mm:ss"),endTime:w(o.value.endTime,"yyyy-MM-dd HH:mm:ss")};e.length;const[s,n]=await Promise.allSettled([e.length>0?he({...m,ids:e,period:o.value.period,count:1e4,aggType:o.value.aggType}):Promise.resolve(null),t.length>0?ye({...m,ids:t}):Promise.resolve(null)]);if(s.status==="fulfilled"&&s.value)if(s.value.code===200){s.value.data;const a={};o.value.checkList.forEach(i=>{a[i.nodeId]=`${q(i.nodeId)}-${i.name}`});const l={};for(const[i,d]of Object.entries(s.value.data))a[i]?l[a[i]]=d:l[i]=d;F(s.value.data),D.value=E(l)}else console.error("getNoBoolData接口返回错误:",s.value.message);else s.status==="rejected"&&console.error("getNoBoolData接口调用失败:",s.reason)}catch(e){console.error("数据处理过程中发生错误:",e)}finally{x.value=!1}};function q(e){return e.split(".")[0]}const A=async()=>{try{const e=o.value.checkList.map(s=>s.nodeId),t={startTime:w(o.value.startTime,"yyyy-MM-dd HH:mm:ss"),endTime:w(o.value.endTime,"yyyy-MM-dd HH:mm:ss"),count:Number(o.value.count)};let m=await _e({...t,ids:e});if(m.code===200){m.data,o.value.checkList;const s={};o.value.checkList.forEach(a=>{s[a.nodeId]=`${q(a.nodeId)}-${a.name}`});const n={};for(const[a,l]of Object.entries(m.data))s[a]?n[s[a]]=l:n[a]=l;F(n),D.value=E(n),D.value}}catch(e){console.error("数据处理过程中发生错误:",e)}finally{x.value=!1}},E=e=>{const t=[];for(const[m,s]of Object.entries(e)){const n={name:`${m}`,data:[]};s.forEach(a=>{const l=new Date(a.timestamp*1e3),i=l.getFullYear(),d=(l.getMonth()+1).toString().padStart(2,"0"),h=l.getDate().toString().padStart(2,"0"),g=l.getHours().toString().padStart(2,"0"),y=l.getMinutes().toString().padStart(2,"0"),$=l.getSeconds().toString().padStart(2,"0");let T="";o.value.isHistory==="1"?T=`${i}-${d}-${h} ${g}:${y}`:T=`${i}-${d}-${h} ${g}:${y}:${$}`;const S=parseFloat(a.val);isNaN(S)||n.data.push({x:T,y:S})}),t.push(n)}return t},F=e=>{const t=Object.keys(e);if(t.length===0){B.value=[],P.value=[];return}const s=e[t[0]].map(a=>{const l=new Date(a.timestamp*1e3),i=l.getFullYear(),d=(l.getMonth()+1).toString().padStart(2,"0"),h=l.getDate().toString().padStart(2,"0"),g=l.getHours().toString().padStart(2,"0"),y=l.getMinutes().toString().padStart(2,"0"),$=l.getSeconds().toString().padStart(2,"0");return o.value.isHistory=="1"?`${i}-${d}-${h} ${g}:${y}`:`${i}-${d}-${h} ${g}:${y}:${$}`}),n=e;B.value=[{field:"deviceName",label:p("device.deviceName"),width:150,fixed:"left"},...s.map((a,l)=>({field:`time_${l}`,label:a,width:100,formatter:i=>{const d=n[i.deviceName];return d&&d[l]?d[l].val:"-"}}))],P.value=t.map(a=>{const l={deviceName:a},i=e[a],d=Math.max(...Object.values(e).map(g=>g.length));return(i.length>=d?i.slice(0,d):[...i,...Array(d-i.length).fill({val:"-"})]).forEach((g,y)=>{l[`time_${y}`]=g.val}),l})},oe=()=>{window.location.reload()};return(e,t)=>{const m=f("el-radio"),s=f("el-radio-group"),n=f("el-form-item"),a=f("el-input"),l=f("el-option"),i=f("el-select"),d=f("el-date-picker"),h=f("el-button"),g=f("el-form"),y=f("ElInput"),$=f("el-checkbox"),T=f("el-tree"),S=f("el-card"),le=ie("loading");return b(),M(j,null,[r(v(me),{style:{"margin-bottom":"2px"}},{default:u(()=>[r(g,{model:o.value,"label-position":"left",inline:!0},{default:u(()=>[r(n,null,{default:u(()=>[r(s,{modelValue:o.value.isHistory,"onUpdate:modelValue":t[0]||(t[0]=c=>o.value.isHistory=c)},{default:u(()=>[r(m,{value:"2",size:"large"},{default:u(()=>[V(I(v(p)("device.normalQuery")),1)]),_:1}),r(m,{value:"1",size:"large"},{default:u(()=>[V(I(v(p)("device.aggregateQuery")),1)]),_:1})]),_:1},8,["modelValue"])]),_:1}),N(r(n,{label:v(p)("device.queryCount")},{default:u(()=>[r(a,{modelValue:o.value.count,"onUpdate:modelValue":t[1]||(t[1]=c=>o.value.count=c),type:"number",style:{width:"100px"}},null,8,["modelValue"])]),_:1},8,["label"]),[[L,o.value.isHistory==="2"]]),N(r(n,{label:v(p)("device.aggregateMethod")},{default:u(()=>[r(i,{modelValue:o.value.aggType,"onUpdate:modelValue":t[2]||(t[2]=c=>o.value.aggType=c),placeholder:"请选择单位",filterable:"",clearable:""},{default:u(()=>[(b(!0),M(j,null,Q(Y.value,c=>(b(),G(l,{key:c.value,label:c.label,value:c.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),[[L,o.value.isHistory==="1"]]),N(r(n,{label:v(p)("device.aggregateCycle")},{default:u(()=>[r(i,{modelValue:o.value.period,"onUpdate:modelValue":t[3]||(t[3]=c=>o.value.period=c),placeholder:"请选择聚合时间",filterable:"",clearable:""},{default:u(()=>[(b(!0),M(j,null,Q(K.value,c=>(b(),G(l,{key:c.value,label:c.label,value:c.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),[[L,o.value.isHistory==="1"]]),r(n,{label:v(p)("device.startTime")},{default:u(()=>[r(d,{modelValue:o.value.startTime,"onUpdate:modelValue":t[4]||(t[4]=c=>o.value.startTime=c),type:"datetime"},null,8,["modelValue"])]),_:1},8,["label"]),r(n,{label:v(p)("device.endTime")},{default:u(()=>[r(d,{modelValue:o.value.endTime,"onUpdate:modelValue":t[5]||(t[5]=c=>o.value.endTime=c),type:"datetime"},null,8,["modelValue"])]),_:1},8,["label"]),r(n,null,{default:u(()=>[r(h,{type:"primary",icon:v(pe),onClick:Z},{default:u(()=>[V(I(v(p)("device.query")),1)]),_:1},8,["icon"]),r(h,{icon:v(ve),onClick:oe},{default:u(()=>[V(I(v(p)("searchDemo.reset")),1)]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"])]),_:1}),N((b(),M("div",ke,[r(S,{class:"w-300px flex flex-col overflow-x-auto","body-style":{height:U.value,overflow:"auto"}},{default:u(()=>[k("div",we,[k("div",xe,[r(y,{placeholder:v(p)("common.inputText")},null,8,["placeholder"])])]),k("div",$e,[r(T,{ref:"treeRef",data:C.value,props:J.value,class:"h-full w-full min-w-full w-300px tree-container","node-key":"id",load:X,lazy:""},{default:u(({node:c,data:H})=>[k("div",Te,[N(r($,{modelValue:H.checked,"onUpdate:modelValue":R=>H.checked=R,onChange:R=>ae(H)},null,8,["modelValue","onUpdate:modelValue","onChange"]),[[L,te(H,c)]]),k("span",Se,I(c.label),1)])]),_:1},8,["data","props"])])]),_:1},8,["body-style"]),r(S,{class:"flex-1 ml-5px h-full","body-style":{height:U.value,overflow:"auto"}},{default:u(()=>[r(v(ce),{ref:"chartRef",type:"area",height:"60%",options:W,series:D.value,style:{"overflow-x":"hidden","overflow-y":"hidden"}},null,8,["series"]),k("div",Ie,[r(v(be),{columns:B.value,data:P.value,showAction:"","max-height":"200"},null,8,["columns","data"])])]),_:1},8,["body-style"])])),[[le,x.value]])],64)}}});export{Qe as default};
