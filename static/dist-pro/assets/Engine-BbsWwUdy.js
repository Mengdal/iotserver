import{_ as de}from"./Table.vue_vue_type_script_lang-D3v-kC-o.js";import{_ as F}from"./ContentWrap.vue_vue_type_script_setup_true_lang-CrtdylkU.js";import{_ as ce}from"./Search.vue_vue_type_script_setup_true_lang-BCCD0GAn.js";import{l as me,d as T,i as pe,b as V,v as O,p as ve}from"./element-plus--V1NSjC4.js";import{d as fe,g as _e,a as ge,b as be,c as ye,e as xe,u as he}from"./index-CYuSvVul.js";import{c as Se,f as we,e as k,_ as Ve}from"./index-CAdyeJt3.js";/* empty css                  */import{x as De,r as g,c as H,X as Re,P as s,O as D,j as Ee,ag as b,y as p,z as y,H as o,u as i,A as d,L as u,M as r,G as z,K as h,a4 as L,aa as Te}from"./vue-chunks-C1K3ngR7.js";/* empty css                        *//* empty css                *//* empty css                  *//* empty css               */import"./el-checkbox-group-Cm0j4lwI.js";/* empty css                *//* empty css                         *//* empty css                  *//* empty css                       */import"./Form-CzZbC4Aj.js";/* empty css               */import"./Highlight.vue_vue_type_script_lang-BYSr0XZy.js";/* empty css                */import"./wang-editor-Bckixh16.js";import"./useForm-CD85wrwf.js";import"./index-DfycOL0q.js";const ke={class:"mb-10px"},Ce={class:"flex-shrink-0 px-2 overflow-auto message-detail"},ze={class:"flex items-center justify-between"},Be={class:"text-[#954121]"},Ie={class:"text-[#000] ml-1"},Me={key:0,class:"ml-1"},qe={key:1,class:"ml-1 text-[#05d94c]"},Ne={key:1,class:"view-container"},Pe={class:"flex-shrink-0 px-2 overflow-auto message-detail"},Ae={class:"flex items-center justify-between"},Ue={class:"text-[#954121]"},$e={class:"text-[#000] ml-1"},je={key:0,class:"ml-1"},Fe={key:1,class:"ml-1 text-[#05d94c]"},Oe={class:"json-preview"},He={class:"json-container"},Le={class:"json-content"},We={class:"drawer-footer"};function N(C){return typeof C=="function"||Object.prototype.toString.call(C)==="[object Object]"&&!Te(C)}const Ke=De({__name:"Engine",setup(C){const{t:e}=Se(),B=g([]),W=g([{value:e("device.messageBus"),label:e("device.messageBus")}]),x=g(!1),v=g("create"),K=H(()=>{if(v.value==="create")return e("device.createRule");if(v.value==="edit")return e("device.editRule");if(v.value==="view")return e("device.viewRule")}),Q=H(()=>window.innerHeight-310),P=g({}),l=g({name:"",description:"",filter:{message_source:e("device.messageBus"),select_name:"*",condition:"",sql:""},resource_type:e("device.httpPush"),DataSourceId:"",id:"",resourceName:""}),_=g({page:1,size:20,name:null,status:null}),R=g({}),G=Re([{field:"status",component:"Select",value:"1",formItemProps:{label:e("device.ruleName"),rules:[{required:!0,message:e("common.inputText")}]},componentProps:{options:[{label:`${e("device.status")}(${e("device.all")})`,value:"1"},{label:e("device.enable"),value:"running"},{label:e("device.disable"),value:"stopped"}]}},{field:"name",label:e("device.ruleName"),component:"Input"}]),I=async()=>{let a=await be({page:1,size:9999999,type:l.value.resource_type});a.code===200&&(B.value=a.data.list.map(t=>({value:t.id,label:t.name})))},J=g([{field:"name",label:e("device.deviceName")},{field:"description",label:e("device.ruleDescription")},{field:"data_resource",label:e("device.forwardingMethod"),formatter:a=>a.data_resource?.type||"无"},{field:"created",label:e("device.createTime"),formatter:a=>we(a.created*1e3,"yyyy-MM-dd HH:mm:ss")},{field:"status",label:e("device.enableStatus"),formatter:a=>{const t=g(a.status==="running"),c=async m=>{try{const w=m?"running":"stopped";(await ye({id:a.id,status:w})).code===200&&(a.status=w,S(),V.success(e("device.operationSuccess")))}catch{t.value=!m,V.error(e("device.operationFailed"))}};return s(k,{permission:"Switch"},{default:()=>[s(me,{modelValue:t.value,"inline-prompt":!0,"active-text":e("device.yes"),"inactive-text":e("device.no"),onChange:c},null)]})}},{field:"action",label:e("device.operation"),width:"240px",formatter:a=>{let t,c,m;return s(D,null,[s(k,{permission:"Details"},{default:()=>[s(T,{text:!0,type:"success",onClick:()=>M(a,"view")},N(t=e("device.details"))?t:{default:()=>[t]})]}),s(k,{permission:"Edit"},{default:()=>[s(T,{text:!0,type:"primary",onClick:()=>M(a,"edit")},N(c=e("device.edit"))?c:{default:()=>[c]})]}),s(k,{permission:"Delete"},{default:()=>[s(T,{text:!0,type:"danger",onClick:()=>M(a,"delete")},N(m=e("device.delete"))?m:{default:()=>[m]})]})])}}]),M=async(a,t)=>{if(l.value.id=a.name,t==="view")v.value="view",A(a),X(a.name),x.value=!0;else if(t==="edit")try{A(a),v.value="edit",await I(),x.value=!0}catch(c){console.error("解析filter数据失败:",c),l.value={name:a.name,description:a.description||"",filter:{message_source:e("device.messageBus"),select_name:"*",condition:"",sql:""},resource_type:a.data_resource?.type||e("device.httpPush"),DataSourceId:a.data_resource?.id||"",id:a.id},l.value,v.value="edit",await I(),x.value=!0}else t==="delete"&&pe.confirm(e("common.delMessage"),e("common.delWarning"),{confirmButtonText:e("common.ok"),cancelButtonText:e("common.cancel"),type:"warning"}).then(()=>{fe({id:a.id}).then(()=>{V.success(e("device.operationSuccess")),S()}).catch(m=>{V.error(`${e("device.operationFailed")}: ${m.message||e("device.unknownError")}`)})})},X=async a=>{let t=await _e({name:a});t.code===200&&(t.data,P.value=t.data)},A=a=>{const t=a.filter?JSON.parse(a.filter):{};l.value={name:a.name,description:a.description||"",filter:{message_source:t.messageSource||e("device.messageBus"),select_name:t.selectName||"*",condition:t.condition||"",sql:t.sql||""},resource_type:a.data_resource?.type||e("device.httpPush"),DataSourceId:a.data_resource?.id||"",id:a.id,resourceName:a.data_resource?.name||""},l.value};Ee(()=>{S()});const S=async()=>{let a=await ge(_.value);a.code===200&&(R.value=a.data,R.value)},Z=O(async a=>{_.value.size=a,S()},300),Y=O(async a=>{_.value.page=a,S()},300),ee=()=>{l.value.name="",l.value.description="",v.value="create",x.value=!0},te=()=>{v.value=="create"?ae():le()},ae=async()=>{(await xe({description:l.value.description,name:l.value.name})).code===200&&(V.success(e("device.operationSuccess")),x.value=!1,S())},le=async()=>{l.value;let a={DataSourceId:l.value.DataSourceId,description:l.value.description,filter:{condition:l.value.filter.condition,messageSource:l.value.filter.message_source,selectName:l.value.filter.select_name,sql:`SELECT ${l.value.filter.select_name} FROM stream WHERE ${l.value.filter.condition||""}`},id:l.value.id,name:l.value.name};(await he(a)).code===200&&(V.success(e("device.operationSuccess")),x.value=!1,S())},se=(a,t,c)=>{if(!t)return c(new Error(e("device.pleaseEnterIdentifier")));if(/^[0-9]/.test(t))return c(new Error(e("device.identifierCannotStartWithNumber")));if(!/^[a-zA-Z0-9\-_#@\s]+$/.test(t))return c(new Error(e("device.identifierOnlyAllowChars")));c()},oe=g({name:[{required:!0,message:e("common.inputText"),trigger:"blur"},{validator:se,trigger:"blur"}],select_name:[{required:!0,message:e("common.inputText"),trigger:"blur"}],resource_type:[{required:!0,message:e("common.selectText"),trigger:"change"}],DataSourceId:[{required:!0,message:e("common.selectText"),trigger:"blur"}],"filter.condition":[{required:!0,message:e("common.inputText"),trigger:"blur"}]}),ie=a=>{_.value.page=1,_.value.name=a.name,a.status==="1"?_.value.status=null:_.value.status=a.status,_.value,S()},ne=a=>{B.value=[],l.value.DataSourceId="",l.value.resource_type=a,I()};return(a,t)=>{const c=b("BaseButton"),m=b("el-divider"),w=b("el-input"),f=b("el-form-item"),U=b("el-option"),$=b("el-select"),E=b("el-radio"),re=b("el-radio-group"),j=b("el-form"),q=b("el-text"),ue=b("el-drawer");return p(),y(D,null,[s(i(F),{style:{"margin-bottom":"2px"}},{default:o(()=>[s(i(ce),{schema:G,onSearch:ie,"show-reset":!1},null,8,["schema"])]),_:1}),s(i(F),null,{default:o(()=>[d("div",ke,[s(i(k),{permission:"Create"},{default:o(()=>[s(c,{type:"primary",icon:i(ve),onClick:ee},{default:o(()=>[u(r(i(e)("device.addRule")),1)]),_:1},8,["icon"])]),_:1})]),s(i(de),{pageSize:_.value.size,"onUpdate:pageSize":[t[0]||(t[0]=n=>_.value.size=n),i(Z)],currentPage:_.value.page,"onUpdate:currentPage":[t[1]||(t[1]=n=>_.value.page=n),i(Y)],columns:J.value,height:Q.value,data:R.value.list,border:!1,headerAlign:"center",showAction:"",pagination:{total:R.value.totalRow?R.value.totalRow:0,pageSizes:[10,20,50],layout:"total, sizes, prev, pager, next, jumper"}},null,8,["pageSize","currentPage","columns","height","data","pagination","onUpdate:currentPage","onUpdate:pageSize"])]),_:1}),s(ue,{modelValue:x.value,"onUpdate:modelValue":t[10]||(t[10]=n=>x.value=n),title:K.value,size:"50%",direction:"rtl",class:"demo-drawer"},{footer:o(()=>[d("div",We,[s(i(T),{onClick:t[9]||(t[9]=n=>x.value=!1)},{default:o(()=>[u(r(i(e)("common.cancel")),1)]),_:1}),v.value!="view"?(p(),z(i(T),{key:0,type:"primary",onClick:te},{default:o(()=>[u(r(i(e)("dialogDemo.submit")),1)]),_:1})):h("",!0)])]),default:o(()=>[v.value!="view"?(p(),z(j,{key:0,model:l.value,"label-width":"120px",rules:oe.value,ref:"form"},{default:o(()=>[s(m,{"content-position":"left",class:"short-divider"},{default:o(()=>[u(r(i(e)("device.basicInfo")),1)]),_:1}),s(f,{label:i(e)("device.ruleName"),prop:"name"},{default:o(()=>[s(w,{modelValue:l.value.name,"onUpdate:modelValue":t[2]||(t[2]=n=>l.value.name=n),placeholder:i(e)("common.inputText")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s(f,{label:i(e)("device.ruleDescription")},{default:o(()=>[s(w,{modelValue:l.value.description,"onUpdate:modelValue":t[3]||(t[3]=n=>l.value.description=n),type:"textarea",rows:4,placeholder:i(e)("common.inputText")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),l.value.name&&v.value==="edit"?(p(),y(D,{key:0},[s(m,{"content-position":"left",class:"short-divider"},{default:o(()=>[u(r(i(e)("device.conditionFilter")),1)]),_:1}),s(f,{label:i(e)("device.messageSource"),prop:"name"},{default:o(()=>[s($,{modelValue:l.value.filter.message_source,"onUpdate:modelValue":t[4]||(t[4]=n=>l.value.filter.message_source=n)},{default:o(()=>[(p(!0),y(D,null,L(W.value,n=>(p(),z(U,{key:n.value,label:n.label,value:n.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),s(f,{label:i(e)("device.queryFields"),prop:"filter.select_name"},{default:o(()=>[s(w,{modelValue:l.value.filter.select_name,"onUpdate:modelValue":t[5]||(t[5]=n=>l.value.filter.select_name=n),placeholder:i(e)("common.inputText")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s(f,{label:i(e)("device.condition")},{default:o(()=>[s(w,{modelValue:l.value.filter.condition,"onUpdate:modelValue":t[6]||(t[6]=n=>l.value.filter.condition=n),placeholder:i(e)("common.inputText")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),s(f,{label:i(e)("device.sqlStatement")},{default:o(()=>[d("div",Ce,[d("div",ze,[d("span",Be,[t[11]||(t[11]=u(" SELECT ")),d("span",Ie,r(l.value.filter.select_name||"*"),1),t[12]||(t[12]=d("span",{class:"ml-1"},"FROM",-1)),t[13]||(t[13]=d("span",{class:"text-[#000] ml-1"},"stream",-1)),l.value.filter.condition?(p(),y("span",Me,"WHERE")):h("",!0),l.value.filter.condition?(p(),y("span",qe,r(l.value.filter.condition),1)):h("",!0)])])])]),_:1},8,["label"])],64)):h("",!0),l.value.filter.message_source&&v.value==="edit"?(p(),y(D,{key:1},[s(m,{"content-position":"left",class:"short-divider"},{default:o(()=>[u(r(i(e)("device.forwardingMethod")),1)]),_:1}),s(f,{label:i(e)("device.forwardingMethod"),prop:"resource_type"},{default:o(()=>[s(re,{modelValue:l.value.resource_type,"onUpdate:modelValue":t[7]||(t[7]=n=>l.value.resource_type=n),onChange:ne},{default:o(()=>[s(E,{value:"HTTP推送",size:"large"},{default:o(()=>[u(r(i(e)("device.httpPush")),1)]),_:1}),s(E,{value:"消息对队列MQTT",size:"large"},{default:o(()=>[u(r(i(e)("device.messageQueueMqtt")),1)]),_:1}),s(E,{value:"消息队列Kafka",size:"large"},{default:o(()=>[u(r(i(e)("device.messageQueueKafka")),1)]),_:1}),s(E,{value:"InfluxDB",size:"large"},{default:o(()=>t[14]||(t[14]=[u("InfluxDB")])),_:1}),s(E,{value:"TDengine",size:"large"},{default:o(()=>t[15]||(t[15]=[u("TDengine")])),_:1})]),_:1},8,["modelValue"])]),_:1},8,["label"]),s(f,{label:"使用资源",prop:"DataSourceId"},{default:o(()=>[s($,{modelValue:l.value.DataSourceId,"onUpdate:modelValue":t[8]||(t[8]=n=>l.value.DataSourceId=n)},{default:o(()=>[(p(!0),y(D,null,L(B.value,n=>(p(),z(U,{key:n.value,label:n.label,value:n.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})],64)):h("",!0)]),_:1},8,["model","rules"])):h("",!0),v.value=="view"?(p(),y("div",Ne,[s(j,{class:"view-form"},{default:o(()=>[s(m,{"content-position":"right",class:"short-divider"},{default:o(()=>[u(r(i(e)("device.conditionFilter")),1)]),_:1}),s(f,{label:i(e)("device.messageSource"),class:"ml-6 mt-1"},{default:o(()=>[s(q,null,{default:o(()=>[u(r(l.value.filter.message_source),1)]),_:1})]),_:1},8,["label"]),s(f,{label:i(e)("device.sqlStatement"),class:"ml-6"},{default:o(()=>[d("div",Pe,[d("div",Ae,[d("span",Ue,[t[16]||(t[16]=u(" SELECT ")),d("span",$e,r(l.value.filter.select_name||"*"),1),t[17]||(t[17]=d("span",{class:"ml-1"},"FROM",-1)),t[18]||(t[18]=d("span",{class:"text-[#000] ml-1"},"stream",-1)),l.value.filter.condition?(p(),y("span",je,"WHERE")):h("",!0),l.value.filter.condition?(p(),y("span",Fe,r(l.value.filter.condition),1)):h("",!0)])])])]),_:1},8,["label"]),s(m,{"content-position":"right",class:"short-divider"},{default:o(()=>[u(r(i(e)("device.forwardingMethod")),1)]),_:1}),s(f,{label:i(e)("device.forwardingMethod"),prop:"filter.select_name",class:"ml-6 mt-1"},{default:o(()=>[s(q,null,{default:o(()=>[u(r(l.value.resource_type),1)]),_:1})]),_:1},8,["label"]),s(f,{label:i(e)("device.useResource"),prop:"filter.select_name",class:"ml-6"},{default:o(()=>[s(q,null,{default:o(()=>[u(r(l.value.resourceName),1)]),_:1})]),_:1},8,["label"])]),_:1}),d("div",Oe,[d("div",He,[d("pre",Le,r(P.value),1)])])])):h("",!0)]),_:1},8,["modelValue","title"])],64)}}}),bt=Ve(Ke,[["__scopeId","data-v-91ab14cb"]]);export{bt as default};
