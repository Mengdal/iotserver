import{x as de,r as g,c as R,af as V,X as pe,j as fe,ag as L,y,z as k,P as d,H as m,u,L as N,M as b,a6 as ve,O as M,a4 as O,G as $,A as G,V as he,K}from"./vue-chunks-C1K3ngR7.js";import{_ as ge}from"./Table.vue_vue_type_script_lang-D3v-kC-o.js";import{c as ye,e as U,_ as _e}from"./index-CAdyeJt3.js";import{_ as we}from"./ContentWrap.vue_vue_type_script_setup_true_lang-CrtdylkU.js";import{_ as Le}from"./ResizeDialog.vue_vue_type_script_setup_true_lang-BMzjBTUt.js";import"./useValidator-Barz9SCp.js";import{u as Pe}from"./useForm-CD85wrwf.js";import{d as Se,g as Ve,a as be,b as xe,c as Ce,e as ke}from"./index-BST0YArI.js";import{d as T,i as Ae,b as A,v as X}from"./element-plus--V1NSjC4.js";/* empty css                        *//* empty css                *//* empty css                  *//* empty css               */import"./el-checkbox-group-Cm0j4lwI.js";/* empty css                *//* empty css                         *//* empty css                  *//* empty css                       */import"./Dialog.vue_vue_type_style_index_0_lang-aEWcq84Q.js";/* empty css                  */import"./index-DfycOL0q.js";const De={style:{display:"flex","align-items":"center",width:"100%"}},Ne={style:{flex:"1"}},Be={key:0,class:"child-title"},ze=de({__name:"Role",setup(Ee){const{t:l}=ye();Pe();const I=g([]),B=g([]),z=g([]),E=g({}),Q=g(!1),P=g(!1),_=g("create"),J=g(null),Y=R(()=>window.innerHeight-204),Z=R(()=>({create:l("device.create"),edit:l("device.edit"),view:l("device.view")})[_.value]),S=g({page:1,size:10}),ee=[{field:"name",label:l("device.roleName")},{field:"description",label:l("device.roleDescription")},{field:"action",label:l("device.operation"),slots:{default:e=>V("div",[...e.row.userId===0?[V(U,{permission:"Details"},()=>V(T,{type:"success",text:!0,onClick:()=>F(e.row,"view")},{default:()=>l("device.view")}))]:[V(U,{permission:"Edit"},()=>V(T,{type:"primary",text:!0,onClick:()=>F(e.row,"edit")},{default:()=>l("device.edit")})),V(U,{permission:"Delete"},()=>V(T,{type:"danger",text:!0,onClick:()=>F(e.row,"delete")},{default:()=>l("device.delete")}))]])}}],a=g({name:"",description:"",permissions:{}}),ie=pe({name:[{required:!0}],description:[{required:!0}]}),F=async(e,i)=>{if(J.value=e,_.value=i,i==="delete"){Ae.confirm(l("common.delMessage"),l("common.delWarning"),{confirmButtonText:l("common.ok"),cancelButtonText:l("common.cancel"),type:"warning"}).then(()=>{Se({id:e.id}).then(r=>{r.code===200&&(A({type:"success",message:l("device.operationSuccess")}),x())}).catch(r=>{console.error("删除失败",r),A({type:"error",message:l("device.operationFailed")})})}).catch(()=>{A({type:"info",message:l("device.operationCancelled")})});return}if(i==="edit"||i==="view"){const r=await Ve({id:e.id});if(r.code===200){const s=JSON.parse(r.data.permission),o={},h=p=>{p.forEach(c=>{o[c.id]||(o[c.id]=[1]),c.permissionList&&c.permissionList.length>0&&c.permissionList.forEach(t=>{o[c.id].includes(t.id)||o[c.id].push(t.id)}),c.children&&h(c.children)})};h(s),a.value={name:e.name,description:e.description,permissions:o},H()}}P.value=!0},se=()=>{_.value="create",a.value={name:"",description:"",permissions:{}},H(),P.value=!0},te=e=>{const i=r=>r.filter(s=>!s.meta?.hidden).map(s=>{let o=Array.isArray(s.permissionList)?s.permissionList:[];s.permissionList&&typeof s.permissionList=="object"&&!Array.isArray(s.permissionList)&&(o=[]),o.some(p=>p.value==="view")||(o=[{id:1,value:"view",label:l("device.view")},...o]);const h=s.children&&s.children.length>0?i(s.children):[];return{id:s.id,title:s.meta.title,permissionList:o,children:h}});return i(e)},le=e=>{const i=r=>{r.forEach(s=>{s.permissionList&&s.permissionList.length>0&&s.children&&s.children.length>0&&(a.value.permissions[s.id]=a.value.permissions[s.id]||[]),s.children&&s.children.length>0&&i(s.children)})};i(e)},H=async()=>{try{const e=await be();e.code===200&&e.data&&(z.value=e.data,B.value=te(e.data),z.value,le(B.value),I.value=B.value.map(i=>i.id))}catch(e){console.error("获取权限模板失败",e)}},re=e=>Array.isArray(e)?e.filter(i=>i.children.length!==0):e,oe=async()=>{try{if(_.value==="create"){let e=q(z.value,a.value.permissions),i={name:a.value.name,description:a.value.description,permission:JSON.stringify(e)};(await Ce(i)).code===200&&(A.success(l("device.operationSuccess")),P.value=!1,x())}else if(_.value==="edit"){let e=q(z.value,a.value.permissions),i={id:J.value.id,name:a.value.name,description:a.value.description,permission:JSON.stringify(re(e))};(await ke(i)).code===200&&(A.success(l("device.operationSuccess")),P.value=!1,x())}}catch(e){console.error("提交失败",e),A.error(l("device.operationFailed"))}},q=(e,i)=>{const r=c=>JSON.parse(JSON.stringify(c)),s=r(e),o=new Map,h=c=>{c.forEach(t=>{o.set(t.id,t),t.children&&h(t.children)})};h(e);const p=c=>c.filter(t=>{const D=i[t.id]||[],n=D.includes(1);t.permissionList&&(typeof t.permissionList=="object"&&!Array.isArray(t.permissionList)&&(t.permissionList=[]),t.permissionList=t.permissionList.filter(v=>D.includes(v.id))),t.meta&&t.permissionList&&Array.isArray(t.permissionList)&&(t.meta.permission=t.permissionList.filter(v=>v.id!==1).map(v=>v.value),t.meta.permission?.length===0&&delete t.meta.permission),t.meta&&n&&t.meta.alwaysShow&&(t.meta.hidden=!1);let f=!1;if(t.children&&(t.children=p(t.children),f=t.children.length>0),t.permissionList?.some(v=>v.label==="详情"||v.value==="Details")){const v=o.get(t.id);if(v?.children){const j=v.children.filter(w=>w.meta?.hidden).map(w=>r(w));t.children||(t.children=[]);const W=new Set(t.children.map(w=>w.id));for(const w of j)W.has(w.id)||(t.children.push(w),f=!0)}}return n||f});return p(s)},ae=X(async e=>{S.value.size=e,x()},300),ne=X(async e=>{S.value.page=e,x()},300);fe(async()=>{x()});const x=async()=>{const e=await xe(S.value);e.code===200&&(E.value=e.data)},ce=R(()=>e=>!e.children||e.children.length===0?!1:e.children.every(i=>{const r=a.value.permissions[i.id]||[];return(i.permissionList?.map(o=>o.id)||[]).every(o=>r.includes(o))})),me=R(()=>e=>{if(!e.children||e.children.length===0)return!1;const i=e.children.some(s=>(a.value.permissions[s.id]||[]).length>0),r=e.children.every(s=>{const o=a.value.permissions[s.id]||[];return(s.permissionList?.map(p=>p.id)||[]).every(p=>o.includes(p))});return i&&!r}),ue=(e,i)=>{e.children&&(e.children.forEach(r=>{r.permissionList&&r.permissionList.length>0&&(i?a.value.permissions[r.id]=r.permissionList.map(s=>s.id):a.value.permissions[r.id]=[])}),a.value.permissions={...a.value.permissions})};return(e,i)=>{const r=L("el-input"),s=L("el-form-item"),o=L("el-checkbox"),h=L("el-checkbox-group"),p=L("el-collapse-item"),c=L("el-collapse"),t=L("el-form"),D=L("BaseButton");return y(),k(M,null,[d(u(we),null,{default:m(()=>[d(u(U),{permission:"Create"},{default:m(()=>[d(u(T),{type:"primary",onClick:se},{default:m(()=>[N("+ "+b(u(l)("device.create")),1)]),_:1})]),_:1}),d(u(ge),{height:Y.value,pageSize:S.value.size,"onUpdate:pageSize":[i[0]||(i[0]=n=>S.value.size=n),u(ae)],currentPage:S.value.page,"onUpdate:currentPage":[i[1]||(i[1]=n=>S.value.page=n),u(ne)],columns:ee,data:E.value.list,loading:Q.value,showAction:"",pagination:{total:E.value.totalRow?E.value.totalRow:0,pageSizes:[10,20,50],layout:"total, sizes, prev, pager, next, jumper"}},null,8,["height","pageSize","currentPage","data","loading","pagination","onUpdate:currentPage","onUpdate:pageSize"])]),_:1}),d(Le,{modelValue:P.value,"onUpdate:modelValue":i[7]||(i[7]=n=>P.value=n),title:Z.value,initHeight:600,initWidth:600,fullscreen:!1},ve({default:m(()=>[d(t,{model:a.value,rules:ie},{default:m(()=>[d(s,{label:u(l)("device.roleName"),prop:"name"},{default:m(()=>[d(r,{modelValue:a.value.name,"onUpdate:modelValue":i[2]||(i[2]=n=>a.value.name=n)},null,8,["modelValue"])]),_:1},8,["label"]),d(s,{label:u(l)("device.roleDescription"),prop:"description"},{default:m(()=>[d(r,{modelValue:a.value.description,"onUpdate:modelValue":i[3]||(i[3]=n=>a.value.description=n)},null,8,["modelValue"])]),_:1},8,["label"]),d(c,{modelValue:I.value,"onUpdate:modelValue":i[5]||(i[5]=n=>I.value=n)},{default:m(()=>[(y(!0),k(M,null,O(B.value,n=>(y(),$(p,{key:n.id,title:u(l)(n.title),name:n.id},{title:m(()=>[G("div",De,[G("span",Ne,b(e.$t(n.title)),1),_.value!=="view"?(y(),$(o,{key:0,"model-value":ce.value(n),indeterminate:me.value(n),onClick:i[4]||(i[4]=he(()=>{},["stop"])),onChange:f=>ue(n,f),style:{"margin-right":"10px"}},{default:m(()=>[N(b(u(l)("common.selectAll")),1)]),_:2},1032,["model-value","indeterminate","onChange"])):K("",!0)])]),default:m(()=>[(y(!0),k(M,null,O(n.children,f=>(y(),k("div",{key:f.id,class:"child-node"},[f.title!="首页"?(y(),k("div",Be,b(u(l)(f.title)),1)):K("",!0),d(h,{modelValue:a.value.permissions[f.id],"onUpdate:modelValue":C=>a.value.permissions[f.id]=C},{default:m(()=>[(y(!0),k(M,null,O(f.permissionList,C=>(y(),$(o,{key:C.id,value:C.id},{default:m(()=>[N(b(u(l)(C.label)),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])]))),128))]),_:2},1032,["title","name"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["model","rules"])]),_:2},[_.value!=="view"?{name:"footer",fn:m(()=>[d(D,{type:"primary",onClick:oe},{default:m(()=>[N(b(_.value==="delete"?u(l)("device.delete"):u(l)("dialogDemo.submit")),1)]),_:1}),d(D,{onClick:i[6]||(i[6]=n=>P.value=!1)},{default:m(()=>[N(b(u(l)("dialogDemo.close")),1)]),_:1})]),key:"0"}:void 0]),1032,["modelValue","title"])],64)}}}),si=_e(ze,[["__scopeId","data-v-f580c7c3"]]);export{si as default};
