import{g as be,b as Ie,f as Le,h as we}from"./index-BTXJkdku.js";import{g as xe,c as Te,f as C,_ as Ce}from"./index-CAdyeJt3.js";/* empty css                *//* empty css                *//* empty css                */import{m as De}from"./vue3-apexcharts-Bmjr8cT9.js";import{_ as Ve}from"./Table.vue_vue_type_script_lang-D3v-kC-o.js";import{_ as Me}from"./ContentWrap.vue_vue_type_script_setup_true_lang-CrtdylkU.js";import{H as W,w as je,F as Pe,G as Ne,b as Ue}from"./element-plus--V1NSjC4.js";import{g as ze,a as Ae}from"./data-Cu4NlBkL.js";import{x as Fe,r as n,c as Se,j as $e,ag as m,y as p,G as g,H as c,P as r,z as V,O as z,a4 as A,A as L,u as d,K as Ee,M,L as O,n as Re}from"./vue-chunks-C1K3ngR7.js";import"./index-DfycOL0q.js";/* empty css                        *//* empty css                  *//* empty css               */import"./el-checkbox-group-Cm0j4lwI.js";/* empty css                         *//* empty css                  *//* empty css                       */const Oe={class:"flex flex-1 min-h-0"},qe={class:"shrink-0"},Be={class:"flex-1 min-h-0 overflow-hidden"},Ge={class:"flex items-center"},He={class:"ml-2 whitespace-nowrap truncate max-w-180px"},Ke={key:1,class:"el-tree__empty-block"},Je={class:"el-tree__empty-text"},Qe={class:"table-container"},We=Fe({__name:"UsageAnalysis",setup(Xe){const w=xe(),{t:u}=Te(),j=n(!1),v=n("1"),q=n(0),D=n([]),f=n([]),F=n([]),B=Se(()=>`${window.innerHeight-152}px`),x=n([]),X=n([]),Y={chart:{type:"area",stroke:{curve:"smooth"},zoom:{enabled:!0},toolbar:{show:!0,tools:{download:!0,zoom:!0,zoomin:!1,zoomout:!1,pan:!1,reset:!1}}},legend:{show:!0,position:"top",horizontalAlign:"center"},dataLabels:{enabled:!1},markers:{size:0},title:{align:"left"},fill:{type:"gradient",gradient:{shadeIntensity:1,inverseColors:!1,opacityFrom:.5,opacityTo:0,stops:[0,90,100]}},yaxis:{labels:{formatter:function(e){return e}}},xaxis:{labels:{formatter:function(e){return e}}}},t=n({productId:"",propertyIds:"",energyType:"S",period:"date",startTime:C(new Date,"yyyy-MM-dd"),checkList:[],endTime:C(new Date(new Date),"yyyy-MM-dd ")}),S=n([]),P=n([]),G=n([]),$=n([]),N=n(!1),Z=n([{categoryId:"1",displayName:u("device.deviceUsage")},{categoryId:"2",displayName:u("device.tagUsage")},{categoryId:"3",displayName:u("device.areaUsage")}]),ee=e=>{let a=n("");t.value.period==="date"?a.value="yyyy-MM-dd":t.value.period==="month"?a.value="yyyy-MM":t.value.period==="year"&&(a.value="yyyy"),t.value.startTime=C(e,a.value)},te=e=>{v.value=e.props.name,t.value.checkList=[],t.value.propertyIds="",$.value=[],D.value=[],F.value=[],f.value,f.value.length>0?(t.value.productId=f.value[0].value,R(f.value[0].value)):K()},ae=n({label:"name",children:"children",isLeaf:e=>e.isTag}),le=e=>{switch(v.value){case"1":return e.type==="Device";case"3":return e.type==="Position";default:return!1}},oe=e=>{if(e.checked){const a={type:e.type||"",nodeId:e.id};t.value.checkList.some(s=>s.nodeId===a.nodeId&&s.type===a.type)||(t.value.checkList=[...t.value.checkList,a])}else t.value.checkList=t.value.checkList.filter(a=>!(a.nodeId===e.id&&a.type===e.type));N.value=!0,k()},se=async e=>{N.value=!0;let a=n("");e.period==="date"?a.value="yyyy-MM-dd":e.period==="month"?a.value="yyyy-MM":e.period==="year"&&(a.value="yyyy"),t.value={startTime:C(new Date().setDate(new Date().getDate()-5),a.value),endTime:C(new Date,a.value),energyType:e.energyType,period:e.period,checkList:e.checkList,productId:e.productId,propertyIds:e.propertyIds},k()},re=()=>{let e=n("");switch(t.value.period==="date"?e.value="yyyy-MM-dd":t.value.period==="month"?e.value="yyyy-MM":t.value.period==="year"&&(e.value="yyyy"),t.value.checkList,v.value){case"1":case"3":ne();break;case"2":t.value.checkList=S.value;break}t.value.startTime=C(new Date,e.value)},ne=()=>{if(t.value.checkList.length<=1)return;const e=t.value.checkList[0],a=t.value.checkList.slice(1),l=s=>{s.forEach(i=>{a.some(_=>_.nodeId===i.id&&_.type===i.type)&&i.checked!==void 0&&(i.checked=!1),i.children&&l(i.children)})};l(D.value),t.value.checkList=[e],t.value.checkList,k()},ce=async e=>{j.value=!0;let a=n("");e.period==="date"?a.value="yyyy-MM-dd":e.period==="month"?a.value="yyyy-MM":e.period==="year"&&(a.value="yyyy"),k()},k=()=>{switch(v.value){case"1":case"2":case"3":ve();break}},H=async()=>{switch(v.value){case"1":await pe();break;case"2":await de();break;case"3":await ie();break}},ie=async()=>{try{const e=await Le();if(e.code===200){let a=ue(e.data);t.value.checkList=[],a.length>0&&E(a),D.value=a,t.value.checkList.length>0&&k()}}catch(e){console.error("获取位置树失败:",e),Ue.error(u("device.failedToGetLocationData"))}},ue=e=>{if(!e)return[];const a=l=>({id:l.id.toString(),label:l.name,name:l.name,type:"Position",children:l.children?.map(a)||[],isLeaf:!l.children||l.children.length===0});return[a(e)]},de=async()=>{let e=await we({page:1,size:9999999999999});if(e.code===200){N.value=!1;let a=e.data.list.map(l=>({label:l.name,value:l.id}));a.length>0&&(P.value=a,t.value.checkList=[a[0].value],S.value=[a[0].value],k()),P.value}},E=e=>{for(const a of e){if(a.type==="Device"||a.type==="Position"){a.checked=!0;const l={type:a.type,nodeId:a.id};return t.value.checkList.some(i=>i.nodeId===l.nodeId&&i.type===l.type)||(t.value.checkList=[l],S.value=[l]),!0}if(a.children&&a.children.length>0&&E(a.children))return!0}return!1},pe=async()=>{try{let e={};w.getProject.enable?e={projectId:w.getProjectId}:e={projectId:void 0};const l=await Ae(e);if(l.code===200){let s=l.data.filter(i=>i.id===t.value.productId);t.value.checkList=[],s.length>0&&E(s),D.value=s,t.value.checkList.length>0&&k()}}catch(e){console.error("获取树形数据失败:",e)}},ve=async()=>{ee(t.value.startTime);let e={},a=w.getProject;switch(v.value){case"1":e={type:t.value.period==="date"?"day":t.value.period,start:t.value.startTime,end:t.value.endTime,projectId:a.enable?w.getProjectId:void 0,productId:t.value.productId,resourceType:"Raw",propertyIds:t.value.propertyIds,resourceIds:t.value.checkList.length>1?t.value.checkList.map(l=>l.nodeId).join(","):t.value.checkList[0].nodeId,reportType:"analysis",page:1,size:99999999999999};break;case"2":e={type:t.value.period==="date"?"day":t.value.period,start:t.value.startTime,end:t.value.endTime,projectId:a.enable?w.getProjectId:void 0,productId:t.value.productId,resourceType:"Group",propertyIds:t.value.propertyIds,resourceIds:t.value.checkList.length>1?t.value.checkList.map(l=>l).join(","):t.value.checkList[0],reportType:"analysis",page:1,size:99999999999999};break;case"3":e={type:t.value.period==="date"?"day":t.value.period,start:t.value.startTime,end:t.value.endTime,projectId:a.enable?w.getProjectId:void 0,productId:t.value.productId,resourceType:"Position",propertyIds:t.value.propertyIds,resourceIds:t.value.checkList.length>1?t.value.checkList.map(l=>l.nodeId).join(","):t.value.checkList[0].nodeId,reportType:"analysis",page:1,size:99999999999999};break}try{let l=await ze(e);if(l.code===200&&Object.keys(l.data.detail).length>0){N.value=!1,j.value=!1,t.value,x.value;let s=x.value.map(y=>{if(y.value===t.value.propertyIds)return y.label});const h=Object.entries(l.data.detail).map(([y,b])=>({name:`${y}-${s[0]}`,data:b.map(I=>({x:I.first,y:I.second}))})).sort((y,b)=>y.data.length>0&&b.data.length===0?-1:b.data.length>0&&y.data.length===0?1:0);$.value=h,ye(l.data.detail);const _=[];Object.entries(l.data.detail).forEach(([y,b])=>{const I={deviceName:y};b.forEach(T=>{I[T.first]=T.second}),I.total=l.data.summary[y],_.push(I)}),F.value=_}}finally{j.value=!1}},ye=e=>{const a=Array.from(new Set(Object.values(e).flat().map(s=>s.first))).sort((s,i)=>parseInt(s)-parseInt(i));let l;v.value==="1"?l=u("device.deviceName"):v.value==="2"?l=u("device.tagName"):v.value==="3"&&(l=u("device.areaName")),G.value=[{field:"deviceName",label:l,width:150,fixed:"left"},...a.map(s=>({field:s,label:`${s}`,width:100,formatter:i=>i[s]??"-"})),{field:"total",label:u("device.total"),width:120,fixed:"right",formatter:s=>s.total?.toFixed(2)??"-"}]},me=e=>{e.length!==0&&(t.value.checkList=e,k())},K=async()=>{let e=await be({page:1,size:999999});e.code===200&&(f.value=e.data?.list?.map(a=>({label:a.name,value:a.id})),f.value.length>0&&(t.value.productId=f.value[0].value,R(f.value[0].value)))},fe=e=>{x.value=[],t.value.propertyIds="",R(e)},R=async e=>{let a=await Ie({productId:e});a.code===200&&(x.value=[...a.data?.properties?.map(l=>({label:l.name,value:l.id}))],t.value.propertyIds=x.value[0].value,q.value++,H(),await Re())},he=e=>{t.value,H()};return $e(()=>{K()}),(e,a)=>{const l=m("el-tab-pane"),s=m("el-option"),i=m("el-select"),h=m("el-form-item"),_=m("el-form"),y=m("el-checkbox"),b=m("el-tooltip"),I=m("el-checkbox-group"),T=m("el-radio-button"),ge=m("el-radio-group"),ke=m("el-date-picker"),J=m("el-button"),_e=m("el-tabs");return p(),g(d(Me),{style:{"margin-bottom":"2px"}},{default:c(()=>[r(_e,{modelValue:v.value,"onUpdate:modelValue":a[7]||(a[7]=o=>v.value=o),class:"demo-tabs h-full",onTabClick:te},{default:c(()=>[(p(!0),V(z,null,A(Z.value,o=>(p(),g(l,{key:o.categoryId,label:o.displayName,name:o.categoryId},null,8,["label","name"]))),128)),L("div",Oe,[r(d(W),{class:"w-300px flex flex-col overflow-x-auto","body-style":{height:B.value,overflow:"auto"}},{default:c(()=>[L("div",qe,[r(_,null,{default:c(()=>[r(h,null,{default:c(()=>[r(i,{placeholder:d(u)("common.selectText"),modelValue:t.value.productId,"onUpdate:modelValue":a[0]||(a[0]=o=>t.value.productId=o),clearable:"",onChange:fe,style:{width:"110px"}},{default:c(()=>[(p(!0),V(z,null,A(f.value,o=>(p(),g(s,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["placeholder","modelValue"])]),_:1}),r(h,null,{default:c(()=>[(p(),g(i,{placeholder:d(u)("common.selectText"),modelValue:t.value.propertyIds,"onUpdate:modelValue":a[1]||(a[1]=o=>t.value.propertyIds=o),clearable:"",key:q.value,style:{"min-width":"110px"},onChange:he},{default:c(()=>[(p(!0),V(z,null,A(x.value,o=>(p(),g(s,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["placeholder","modelValue"]))]),_:1})]),_:1})]),L("div",Be,[v.value==="1"||v.value==="3"?(p(),g(d(je),{key:0,ref:"treeRef",data:D.value,props:ae.value,"expand-on-click-node":!1,"expanded-keys":X.value,class:"h-full w-full min-w-full w-300px tree-container","node-key":"id","default-expand-all":""},{default:c(({node:o,data:U})=>[L("div",Ge,[le(U)?(p(),g(y,{key:0,modelValue:U.checked,"onUpdate:modelValue":Q=>U.checked=Q,onChange:Q=>oe(U)},null,8,["modelValue","onUpdate:modelValue","onChange"])):Ee("",!0),r(b,{effect:"light",content:o.label,placement:"right"},{default:c(()=>[L("span",He,M(o.label),1)]),_:2},1032,["content"])])]),_:1},8,["data","props","expanded-keys"])):(p(),g(I,{key:1,modelValue:t.value.checkList,"onUpdate:modelValue":a[2]||(a[2]=o=>t.value.checkList=o),class:"vertical-checkbox",onChange:me},{default:c(()=>[P.value.length>0?(p(!0),V(z,{key:0},A(P.value,o=>(p(),g(y,{key:o.value,value:o.value},{default:c(()=>[O(M(o.label),1)]),_:2},1032,["value"]))),128)):(p(),V("div",Ke,[L("span",Je,M(d(u)("device.noDataAvailable")),1)]))]),_:1},8,["modelValue"]))])]),_:1},8,["body-style"]),r(d(W),{class:"flex-1 ml-5px h-full","body-style":{height:B.value,overflow:"auto"}},{default:c(()=>[r(_,{model:t.value,"label-width":"auto","label-position":"left",inline:!0},{default:c(()=>[r(h,{label:d(u)("device.timeCycle")},{default:c(()=>[r(ge,{modelValue:t.value.period,"onUpdate:modelValue":a[3]||(a[3]=o=>t.value.period=o),onChange:a[4]||(a[4]=o=>se(t.value))},{default:c(()=>[r(T,{label:d(u)("device.day"),value:"date"},null,8,["label"]),r(T,{label:d(u)("formDemo.month"),value:"month"},null,8,["label"]),r(T,{label:d(u)("formDemo.year"),value:"year"},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["label"]),r(h,{label:d(u)("device.queryTime")},{default:c(()=>[r(ke,{modelValue:t.value.startTime,"onUpdate:modelValue":a[5]||(a[5]=o=>t.value.startTime=o),type:t.value.period},null,8,["modelValue","type"])]),_:1},8,["label"]),r(h,null,{default:c(()=>[r(J,{type:"primary",onClick:a[6]||(a[6]=o=>ce(t.value)),icon:d(Pe),loading:j.value},{default:c(()=>[O(M(d(u)("device.query")),1)]),_:1},8,["icon","loading"]),r(J,{icon:d(Ne),onClick:re},{default:c(()=>[O(M(d(u)("common.reset")),1)]),_:1},8,["icon"])]),_:1})]),_:1},8,["model"]),r(d(De),{ref:"chartRef",type:"area",height:"60%",options:Y,series:$.value,style:{"overflow-x":"hidden","overflow-y":"hidden"}},null,8,["series"]),L("div",Qe,[r(d(Ve),{columns:G.value,data:F.value,showAction:"","max-height":"200"},null,8,["columns","data"])])]),_:1},8,["body-style"])])]),_:1},8,["modelValue"])]),_:1})}}}),ht=Ce(We,[["__scopeId","data-v-0b1602a8"]]);export{ht as default};
