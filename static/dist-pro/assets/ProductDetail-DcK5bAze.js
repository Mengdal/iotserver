import{b as g,m as Y,d as b,i as q,F as Se,M as Ce,k as Pe,p as Ne}from"./element-plus--V1NSjC4.js";import{d as K}from"./dateUtil-HUUeH7cc.js";import{b as Ie,u as Oe,v as ze,w as Me,s as Ve}from"./index-BTXJkdku.js";import{x as Fe,r as v,c as P,aA as Le,aH as Ue,j as Be,P as l,L as r,n as $,ag as y,y as M,z as D,H as o,A as k,M as u,u as s,O as Ee,a4 as Je,G as Q,K as X,aa as Ye}from"./vue-chunks-C1K3ngR7.js";import{_ as $e}from"./Table.vue_vue_type_script_lang-D3v-kC-o.js";import{c as je,_ as He}from"./index-CAdyeJt3.js";/* empty css               */import Re from"./drawerForm-DWtu_wAX.js";import"./index-DfycOL0q.js";/* empty css                        *//* empty css                *//* empty css                  */import"./el-checkbox-group-Cm0j4lwI.js";/* empty css                *//* empty css                         *//* empty css                  *//* empty css                       */import"./EnumInputComponent-BjK-eMKZ.js";const Ae={class:"root-container"},Ge={style:{display:"flex","justify-content":"space-between","margin-bottom":"10px"}},We={style:{display:"flex","align-items":"center",gap:"10px"}},qe={class:"pagination-container"};function j(N){return typeof N=="function"||Object.prototype.toString.call(N)==="[object Object]"&&!Ye(N)}const Ke=Fe({__name:"ProductDetail",setup(N){const{t:a}=je(),x=v([]);let H=v();const f=v(!1),V=v(!1),F=v("all"),R=v(""),T=v("create"),Z={create:a("device.create"),edit:a("device.edit"),view:a("device.view")},I=v(!0),ee=P(()=>Z[T.value]||""),m=v(),te=[{value:"all",label:a("device.functionTypeAll")},{value:"attribute",label:a("device.attribute")},{value:"event",label:a("device.event")},{value:"serve",label:a("device.service")}],L=v(!1),ae=Le(),S=Ue(),p=v({}),h=v(1),C=v(10),le=[10,20,50,100],O=v(""),w=v({properties:[],events:[],actions:[]}),ne=()=>{ae.push("/device/product")},se=P(()=>window.innerHeight-500);Be(()=>{R.value=JSON.parse(S.params.params).productId,U()});const U=async()=>{try{L.value=!0;const e=await Ie({productId:JSON.parse(S.params.params).productId});e.code===200?(p.value=e.data,w.value={properties:e.data.properties||[],events:e.data.events||[],actions:e.data.actions||[]}):g.error(a("device.failedToGetProductDetails"))}catch(e){console.error("初始化错误:",e),g.error(a("device.initializationFailed"))}finally{L.value=!1}},oe=e=>{switch(e){case"attribute":return w.value.properties.map(t=>({...t,__type:"attribute"}));case"event":return w.value.events.map(t=>({...t,__type:"event"}));case"serve":return w.value.actions.map(t=>({...t,__type:"serve"}));case"all":default:return[...w.value.properties.map(t=>({...t,__type:"attribute"})),...w.value.events.map(t=>({...t,__type:"event"})),...w.value.actions.map(t=>({...t,__type:"serve"}))]}},A=P(()=>{const e=oe(F.value);if(!O.value)return e;const t=O.value.toLowerCase();return e.filter(i=>i.name&&i.name.toLowerCase().includes(t)||i.code&&i.code.toLowerCase().includes(t))}),ie=P(()=>{const e=(h.value-1)*C.value,t=e+C.value;return A.value.slice(e,t)}),re=()=>{h.value=1},ce=()=>{h.value=1},de=e=>{h.value=e},ue=e=>{C.value=e,h.value=1},pe=[{field:"tag",label:a("device.functionType"),width:140,formatter:e=>{let t="";return e.__type==="attribute"?t=a("device.attributeType"):e.__type==="event"?t=a("device.eventType"):e.__type==="serve"&&(t=a("device.serviceType")),l("div",{style:"display: flex; align-items: center;"},[l("span",{style:"margin-right: 10px"},[r(" "),t]),l(Y,{size:"small",type:"primary"},{default:()=>[e.tag||a("device.custom")]})])}},{field:"name",label:a("device.functionName")},{field:"code",label:a("device.identifier")},{field:"access_mode",label:a("device.readWriteType"),width:90},{field:"type_spec",label:a("device.dataType"),width:90,formatter:e=>{try{return JSON.parse(e.type_spec).type}catch{return"-"}}},{field:"type_spec",label:a("device.dataDefinition"),formatter:e=>{try{const t=JSON.parse(e.type_spec);if(t.type==="enum")try{const n=typeof t.specs=="string"?JSON.parse(t.specs):t.specs;return l("div",{class:"enum-spec-container",style:"display: grid;grid-template-columns: repeat(4, 1fr);width: 100%;"},[n.map((c,_)=>{const[z,J]=Object.entries(c)[0];return l("div",{key:`${z}-${_}`,class:"enum-item"},[l(Y,{type:"primary",size:"small",style:"margin-right: 2px"},{default:()=>[z,r(": "),J]})])})])}catch(n){return console.error("解析枚举 specs 失败:",n),l("span",{class:"error-text"},[a("device.enumDataParsingError")])}const i=n=>{let c={};try{typeof n.specs=="string"?c=JSON.parse(n.specs):typeof n.specs=="object"&&n.specs!==null&&(c=n.specs)}catch(_){console.error("解析 specs 失败:",_),c={}}return l("div",{class:"spec-container"},[l("div",{class:"spec-range"},[l("span",null,[a("device.valueRange"),r(": "),c.min??"-",r(" ~ "),c.max??"-"])]),l("div",{class:"spec-meta"},[l("div",null,[a("device.step"),r(": "),c.step??"-"]),l("div",null,[a("device.unit"),r(": "),c.unitName??c.unit??"-"])])])};switch(t.type){case"int":case"float":case"double":return i(t);case"text":return l("span",null,[a("device.dataLength"),r(": "),t.specs.length]);case"array":const n=JSON.parse(t.specs);return l("div",null,[l("div",null,[a("device.elementType"),r(": "),n.item?.type||a("device.unknown")]),l("div",null,[a("device.elementCount"),r(": "),n.size||a("device.unknown")])]);default:return l("span",null,[a("device.unknownType")])}}catch{return l("span",null,[r("-")])}}},{field:"description",label:a("device.description")},{field:"created",label:a("device.createTime"),formatter:e=>K(e.created*1e3).format("YYYY-MM-DD HH:mm:ss")},{field:"action",label:a("device.operation"),width:220,slots:{default:e=>{let t,i,n;return l("div",null,[l(b,{type:"success",text:!0,onClick:()=>B(e.row,"view")},j(t=a("device.view"))?t:{default:()=>[t]}),l(b,{type:"primary",text:!0,onClick:()=>B(e.row,"edit")},j(i=a("device.edit"))?i:{default:()=>[i]}),l(b,{type:"danger",text:!0,onClick:()=>B(e.row,"del")},j(n=a("device.delete"))?n:{default:()=>[n]})])}}}],B=async(e,t)=>{if(t==="view"){if(T.value="view",I.value=!1,f.value=!0,await $(),!m.value)return;m.value.setFormData(e,t)}else if(t==="edit"){if(await W(),H.value=e.id,I.value=!0,f.value=!0,T.value="edit",await $(),!m.value)return;m.value&&m.value.setUnitOptions(x.value),m.value.setFormData(e,t)}else if(t==="del"){T.value="del";let i="";switch(e.__type){case"attribute":i="property";break;case"event":i="event";break;case"serve":i="action";break}let n={id:e.id,thingModelType:i};q.confirm(a("common.delMessage"),a("common.delWarning"),{confirmButtonText:a("common.ok"),cancelButtonText:a("common.cancel"),type:"warning"}).then(()=>{Oe(n).then(c=>{c.code===200&&(g.success(a("device.operationSuccess")),U())})})}},ve=async()=>{await W(),I.value=!0,f.value=!0,T.value="create",await $(),m.value&&m.value.setUnitOptions(x.value)},me=async()=>{try{V.value=!0;const e=await m.value.validateForm();if(e.unit&&x.value){const c=x.value.find(_=>_.value===e.unit);c&&(e.unit=c.label)}const t=ge(e),i=T.value==="edit"?{id:H.value,...t}:t,n=await Me(i);if(n.code===200)g.success(a("device.operationSuccess")),f.value=!1,U();else throw new Error(n.message||a("device.operationFailed"))}catch(e){console.error("操作出错:",e),g.error(e.message||a("device.operationFailed"))}finally{V.value=!1}},G=e=>{let t={};if(e.type_spec==="int"||e.type_spec==="float"||e.type_spec==="double")t.step=e.step,t.valueType=e.valueType,t.unit=e.unit;else if(e.type_spec==="text")t.length=e.length;else if(e.type_spec==="bool")t[0]=e.false_value,t[1]=e.true_value;else if(e.type_spec==="enum"){if(!e.specs)return{};const i={};return e.specs.forEach(n=>{if(n?.key!==void 0&&n?.value!==void 0){const c=typeof n.key=="number"?n.key.toString():n.key;i[c]=n.value}}),i}return t},E=e=>({code:e.code,name:e.name,type:e.type_spec,specs:G(e)}),ye=e=>({thing_model_type:"property",product_id:JSON.parse(S.params.params).productId,name:e.name,code:e.code,tag:a("device.custom"),property:{access_model:e.read_write==="r"?"R":"RW",require:!1,specs:G(e),type:e.type_spec},type:e.type,description:e.description}),fe=e=>({thing_model_type:"event",product_id:JSON.parse(S.params.params).productId,type:e.type,name:e.name,code:e.code,tag:a("device.custom"),event:{event_type:e.envent_type,output_param:e.outputParams.map(E)},description:e.description}),_e=e=>({thing_model_type:"action",product_id:JSON.parse(S.params.params).productId,type:e.type,name:e.name,code:e.code,tag:a("device.custom"),description:e.description,action:{call_type:e.callMethod==="synchronous"?"SYNC":"ASYNC",input_param:e.inputParams.map(E),output_param:e.outputParams.map(E)}}),ge=e=>{switch(e.typeValue){case"attribute":return ye(e);case"event":return fe(e);case"serve":return _e(e);default:throw new Error(a("device.unknownFunctionType"))}},W=async()=>{try{const e=await ze({page:1,size:1e3});e.code===200?x.value=e.data.list.map(t=>({label:`${t.unit_name}(${t.symbol})`,value:t.id})):g.error(a("device.failedToGetUnitList"))}catch(e){console.error("获取单位列表失败:",e),g.error(a("device.failedToGetUnitList"))}};let be=P(()=>p.value.status===1?a("device.confirmStopPublishingThisProduct"):a("device.confirmPublishThisProduct"));const he=async()=>{p.value;let e=p.value,t={name:e.name,status:!e.status,description:e.description,nodeType:e.nodeType,factory:e.factory,categoryId:e.categoryId,id:e.id};q.confirm(`${be.value}`,a("common.delWarning"),{confirmButtonText:a("common.ok"),cancelButtonText:a("common.cancel"),type:"warning"}).then(()=>{Ve(t).then(i=>{i.code===200&&(window.location.reload(),g.success(a("device.operationSuccess")))})})};return(e,t)=>{const i=y("el-space"),n=y("el-descriptions-item"),c=y("el-descriptions"),_=y("el-card"),z=y("el-option"),J=y("el-select"),we=y("el-icon"),ke=y("el-input"),Te=y("el-pagination"),xe=y("el-drawer");return M(),D("div",Ae,[l(_,{class:"top-section"},{header:o(()=>[k("span",{class:"el-card__header_title",onClick:t[0]||(t[0]=d=>ne())},"↩ "+u(s(a)("device.return")),1)]),default:o(()=>[l(c,{class:"my-card",border:"",column:3},{title:o(()=>[l(i,{size:10},{default:o(()=>[k("span",null,u(p.value.name),1),l(s(Y),{type:p.value.status===1?"success":"danger",onClick:he,style:{cursor:"pointer"}},{default:o(()=>[r(u(p.value.status===1?s(a)("device.publish"):s(a)("device.unpublished")),1)]),_:1},8,["type"])]),_:1})]),default:o(()=>[l(n,{label:s(a)("device.productId")},{default:o(()=>[r(u(p.value.id),1)]),_:1},8,["label"]),l(n,{label:s(a)("device.type")},{default:o(()=>[r(u(p.value.nodeType),1)]),_:1},8,["label"]),l(n,{label:s(a)("device.model")},{default:o(()=>[r(u(p.value.dataFormat),1)]),_:1},8,["label"]),l(n,{label:s(a)("device.factoryName")},{default:o(()=>[r(u(p.value.factory),1)]),_:1},8,["label"]),l(n,{label:s(a)("device.productProtocol")},{default:o(()=>[r(u(p.value.protocol),1)]),_:1},8,["label"]),l(n,{label:s(a)("device.networkType")},{default:o(()=>[r(u(p.value.netType),1)]),_:1},8,["label"]),l(n,{label:s(a)("device.description")},{default:o(()=>[r(u(p.value.description),1)]),_:1},8,["label"]),l(n,{label:s(a)("device.createTime")},{default:o(()=>[r(u(s(K)(p.value.created*1e3).format("YYYY-MM-DD HH:mm:ss")),1)]),_:1},8,["label"])]),_:1})]),_:1}),l(_,{style:{"margin-top":"10px"}},{default:o(()=>[k("div",Ge,[k("div",We,[l(J,{modelValue:F.value,"onUpdate:modelValue":t[1]||(t[1]=d=>F.value=d),style:{width:"180px"},onChange:ce},{default:o(()=>[(M(),D(Ee,null,Je(te,d=>l(z,{key:d.value,label:d.label,value:d.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),l(ke,{modelValue:O.value,"onUpdate:modelValue":t[2]||(t[2]=d=>O.value=d),placeholder:s(a)("device.functionNameOrIdentifier"),clearable:"",onInput:re,style:{width:"180px"}},{prefix:o(()=>[l(we,null,{default:o(()=>[l(s(Se))]),_:1})]),_:1},8,["modelValue","placeholder"])]),k("div",null,[l(s(b),{icon:s(Ce),type:"primary"},{default:o(()=>[r(u(s(a)("device.importData")),1)]),_:1},8,["icon"]),l(s(b),{icon:s(Pe),type:"primary"},{default:o(()=>[r(u(s(a)("device.exportData")),1)]),_:1},8,["icon"]),l(s(b),{icon:s(Ne),onClick:ve,type:"primary"},{default:o(()=>[r(u(s(a)("device.addThingModel")),1)]),_:1},8,["icon"])])]),l(s($e),{columns:pe,data:ie.value,height:se.value,loading:L.value,border:!1},null,8,["data","height","loading"]),k("div",qe,[l(Te,{"current-page":h.value,"onUpdate:currentPage":t[3]||(t[3]=d=>h.value=d),"page-size":C.value,"onUpdate:pageSize":t[4]||(t[4]=d=>C.value=d),"page-sizes":le,small:!1,disabled:!1,background:!0,layout:"total, sizes, prev, pager, next, jumper",total:A.value.length,onSizeChange:ue,onCurrentChange:de},null,8,["current-page","page-size","total"])])]),_:1}),l(xe,{modelValue:f.value,"onUpdate:modelValue":t[7]||(t[7]=d=>f.value=d),title:ee.value,size:"40%",direction:"rtl",class:"demo-drawer"},{footer:o(()=>[k("div",null,[I.value?(M(),Q(s(b),{key:0,type:"primary",loading:V.value,onClick:t[5]||(t[5]=d=>me())},{default:o(()=>[r(u(s(a)("common.ok")),1)]),_:1},8,["loading"])):X("",!0),l(s(b),{onClick:t[6]||(t[6]=d=>f.value=!1)},{default:o(()=>[r(u(s(a)("device.cancel")),1)]),_:1})])]),default:o(()=>[f.value?(M(),Q(Re,{key:0,ref_key:"drawerFormRef",ref:m,productId:R.value},null,8,["productId"])):X("",!0)]),_:1},8,["modelValue","title"])])}}}),mt=He(Ke,[["__scopeId","data-v-44323b24"]]);export{mt as default};
