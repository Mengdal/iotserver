import{_ as se}from"./ContentWrap.vue_vue_type_script_setup_true_lang-CrtdylkU.js";import{g as ne,c as de,f as s,_ as pe}from"./index-CAdyeJt3.js";import{_ as ce}from"./Table.vue_vue_type_script_lang-D3v-kC-o.js";import{u as ie}from"./useTable-Cg8mTZpf.js";import{g as ue,b as ye}from"./index-BTXJkdku.js";import{N as me,F as fe,M as ge}from"./element-plus--V1NSjC4.js";import{g as ve}from"./data-Cu4NlBkL.js";import{e as be}from"./export-BUcENNsn.js";import{x as Ie,r as c,X as W,c as _e,j as Te,ag as u,y as f,G as _,H as n,P as d,u as o,z as D,O as x,a4 as V,L as A,M as E,l as B,n as he}from"./vue-chunks-C1K3ngR7.js";/* empty css                *//* empty css                  *//* empty css                        *//* empty css                *//* empty css               */import"./el-checkbox-group-Cm0j4lwI.js";/* empty css                         *//* empty css                  *//* empty css                       */import"./index-DfycOL0q.js";const He=Ie({__name:"EnergyReportWeek",setup(Me){const y=ne();me.locale("zh-cn",{weekStart:1});const{t:i}=de(),C=c(0),M=c(!1),w=c(!1),g=c("1"),F=c(!1),T=c(new Date),L=c([]),e=W({reportType:"report",type:"interval",search:"",productId:"",propertyIds:[],startTime:s(new Date(new Date().setHours(0,0,0,0)),"yyyy-MM-dd HH:mm:ss"),endTime:s(new Date(new Date),"yyyy-MM-dd HH:mm:ss")}),G=_e(()=>window.innerHeight-290),h=c([]),b=c([]),O=c([{categoryId:"1",displayName:i("device.deviceReport")},{categoryId:"2",displayName:i("device.tagReport")},{categoryId:"3",displayName:i("device.areaReport")}]),$=()=>{M.value=!0,N(T.value),j().finally(()=>{M.value=!1})},q=async()=>{try{w.value=!0;let a={},t=y.getProject;switch(g.value){case"1":a={start:s(e.startTime,"yyyy-MM-dd HH:mm:ss"),end:s(e.endTime,"yyyy-MM-dd HH:mm:ss"),projectId:t.enable?y.getProjectId:void 0,search:e.search,productId:e.productId,propertyIds:e.propertyIds.join(","),type:e.type,reportType:e.reportType,resourceType:"Product"};break;case"2":a={start:s(e.startTime,"yyyy-MM-dd HH:mm:ss"),end:s(e.endTime,"yyyy-MM-dd HH:mm:ss"),projectId:t.enable?y.getProjectId:void 0,search:e.search,productId:e.productId,propertyIds:e.propertyIds.join(","),type:e.type,reportType:e.reportType,resourceType:"Group"};break;case"3":a={start:s(e.startTime,"yyyy-MM-dd HH:mm:ss"),end:s(e.endTime,"yyyy-MM-dd HH:mm:ss"),projectId:t.enable?y.getProjectId:void 0,search:e.search,productId:e.productId,propertyIds:e.propertyIds.join(","),type:e.type,reportType:e.reportType,resourceType:"Position"};break}await be(a,"week")}catch(a){console.error("导出失败:",a)}finally{w.value=!1}},K=a=>{H.value=1,g.value=a.props.name,j()},X=a=>{z(a)},{tableRegister:J,tableState:S,tableMethods:Q}=ie({fetchDataApi:async()=>{const{currentPage:a,pageSize:t}=S;if(T.value,!e.productId||e.propertyIds.length===0)return{list:[],total:0};let l={},m=y.getProject;switch(g.value){case"1":l={page:o(a),size:o(t),start:s(e.startTime,"yyyy-MM-dd HH:mm:ss"),end:s(e.endTime,"yyyy-MM-dd HH:mm:ss"),projectId:m.enable?y.getProjectId:void 0,search:e.search,productId:e.productId,propertyIds:e.propertyIds.join(","),type:e.type,reportType:e.reportType,resourceType:"Product"};break;case"2":l={page:o(a),size:o(t),start:s(e.startTime,"yyyy-MM-dd HH:mm:ss"),end:s(e.endTime,"yyyy-MM-dd HH:mm:ss"),projectId:m.enable?y.getProjectId:void 0,search:e.search,productId:e.productId,propertyIds:e.propertyIds.join(","),type:e.type,reportType:e.reportType,resourceType:"Group"};break;case"3":l={page:o(a),size:o(t),start:s(e.startTime,"yyyy-MM-dd HH:mm:ss"),end:s(e.endTime,"yyyy-MM-dd HH:mm:ss"),projectId:m.enable?y.getProjectId:void 0,search:e.search,productId:e.productId,propertyIds:e.propertyIds.join(","),type:e.type,reportType:e.reportType,resourceType:"Position"};break}let p=W({});try{switch(g.value){case"1":case"2":case"3":p=(await ve(l)).data;break}const I=p.tableLabel?.map(v=>({label:v.label,field:v.prop,fixed:v.fixed}));return L.value=I,{list:p.tableData,total:p.totalRow}}catch(I){return console.error("获取报表数据失败:",I),{list:[],total:0}}}}),{dataList:Y,total:Z,currentPage:H,pageSize:k}=S,{getList:j}=Q,ee=async()=>{let a=await ue({page:1,size:999999});a.code===200&&(b.value=a.data?.list?.map(t=>({label:t.name,value:t.id})),b.value.length>0&&(e.productId=b.value[0].value,await z(b.value[0].value)))},z=async a=>{let t=await ye({productId:a,valueType:"L"});t.code===200&&(h.value=[...t.data?.properties?.map(l=>({label:l.name,value:l.id}))],C.value++,await he(),h.value.length>0?(e.propertyIds=[h.value[0].value],j()):e.propertyIds=[])};Te(()=>{ee()});const te=({row:a,rowIndex:t})=>a.dn==="小计"?"warning-row":a.position==="合计"||a.categorySub==="合计"||a.group==="合计"?"even-row":"",N=a=>{if(!a)return;const t=R(a),l=ae(a);t.setHours(0,0,0,0),l.setHours(23,59,59,999),e.startTime=s(t,"yyyy-MM-dd HH:mm:ss"),e.endTime=s(l,"yyyy-MM-dd HH:mm:ss"),e.startTime,e.endTime},R=a=>{const t=new Date(a),l=t.getDay(),m=t.getDate()-l+(l===0?-6:1);return new Date(t.setDate(m))},ae=a=>{const t=R(a),l=new Date(t);return l.setDate(t.getDate()+6),l};return(a,t)=>{const l=u("el-option"),m=u("el-select"),p=u("el-form-item"),I=u("el-input"),v=u("el-date-picker"),U=u("el-button"),re=u("el-form"),oe=u("el-tab-pane"),le=u("el-tabs");return f(),_(o(se),null,{default:n(()=>[d(re,{model:e,class:"search-form",inline:!0},{default:n(()=>[d(p,{label:o(i)("device.productName")},{default:n(()=>[d(m,{modelValue:e.productId,"onUpdate:modelValue":t[0]||(t[0]=r=>e.productId=r),clearable:"",onChange:X,style:{width:"120px"}},{default:n(()=>[(f(!0),D(x,null,V(b.value,r=>(f(),_(l,{key:r.value,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),d(p,{label:o(i)("device.attributeName")},{default:n(()=>[(f(),_(m,{modelValue:e.propertyIds,"onUpdate:modelValue":t[1]||(t[1]=r=>e.propertyIds=r),multiple:"",clearable:"",key:C.value,style:{"min-width":"150px"}},{default:n(()=>[(f(!0),D(x,null,V(h.value,r=>(f(),_(l,{key:r.value,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]))]),_:1},8,["label"]),d(p,{label:o(i)("device.deviceName")},{default:n(()=>[d(I,{modelValue:e.search,"onUpdate:modelValue":t[2]||(t[2]=r=>e.search=r),placeholder:o(i)("common.inputText")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),d(p,{label:"周"},{default:n(()=>[d(v,{modelValue:T.value,"onUpdate:modelValue":t[3]||(t[3]=r=>T.value=r),type:"week",format:e.startTime+" ~ "+e.endTime+"  [第]ww[周]",placeholder:"请选择",style:{"min-width":"400px"},"first-day-of-week":1,onChange:N},null,8,["modelValue","format"])]),_:1}),d(p,null,{default:n(()=>[d(U,{type:"primary",onClick:$,loading:M.value,icon:o(fe)},{default:n(()=>[A(E(o(i)("device.query")),1)]),_:1},8,["loading","icon"]),d(U,{onClick:q,loading:w.value,icon:o(ge)},{default:n(()=>[A(E(o(i)("device.exportData")),1)]),_:1},8,["loading","icon"])]),_:1})]),_:1},8,["model"]),d(le,{modelValue:g.value,"onUpdate:modelValue":t[6]||(t[6]=r=>g.value=r),class:"demo-tabs",onTabClick:K},{default:n(()=>[(f(!0),D(x,null,V(O.value,r=>(f(),_(oe,{key:r.categoryId,label:r.displayName,name:r.categoryId},{default:n(()=>[d(o(ce),{border:!1,pageSize:o(k),"onUpdate:pageSize":t[4]||(t[4]=P=>B(k)?k.value=P:null),size:"small",currentPage:o(H),"onUpdate:currentPage":t[5]||(t[5]=P=>B(H)?H.value=P:null),columns:L.value,data:o(Y),loading:F.value,height:G.value,pagination:{total:o(Z),pageSizes:[20,40,50,100,1e3]},onRegister:o(J),showAction:"",rowClassName:te},null,8,["pageSize","currentPage","columns","data","loading","height","pagination","onRegister"])]),_:2},1032,["label","name"]))),128))]),_:1},8,["modelValue"])]),_:1})}}}),Ge=pe(He,[["__scopeId","data-v-c752e6ee"]]);export{Ge as default};
